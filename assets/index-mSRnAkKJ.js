import{c as _e,m as gt,a as xt,V as ht,O as vt,t as Et,M as je,P as At,h as rt,A as yt,b as bt,d as Ct,e as Rt,l as St,f as Tt,p as zt,g as Lt,w as Bt,i as wt,j as Nt,k as kt,r as Ft}from"./voxel-chunk-C2aVMRXz.js";function It(d){const{canvas:e,chunk:x,N:O,palette:w,camera:P,animSystem:M,animationTransforms:Pe,getMode:te,setMode:J,getOption:V,setOption:ve,getHoverVoxel:Ae,setHoverVoxel:Ue,getHoverFace:Te,setHoverFace:D,setNeedsPick:n,getDragging:ye,setDragging:ze,getLastX:k,setLastX:ae,getLastY:se,setLastY:Le,getMouseX:Xe,setMouseX:ne,getMouseY:be,setMouseY:pe,getLastTime:De,setLastTime:Ye,getRowHoverSurf:ct,setRowHoverSurf:Oe,getRowHoverAdd:lt,setRowHoverAdd:dt,getPlaneHoverSurf:Qe,setPlaneHoverSurf:et,getPlaneHoverAdd:K,setPlaneHoverAdd:H,getContinuousMode:_,setContinuousMode:Y,getLastAppliedVoxel:Ee,setLastAppliedVoxel:ge,buildAllMeshes:tt,applyToolAt:re,updateChunkSizeUI:Be,updateCameraTargetUI:nt,moveCameraTargetX:we,moveCameraTargetY:Ne,moveCameraTargetZ:Ve,clearHistory:He,undo:Ce,redo:Ge,shiftVoxels:oe,expandChunkX:ce,expandChunkY:le,expandChunkZ:Re,shrinkChunkX:j,shrinkChunkY:xe,shrinkChunkZ:de,exportToJSON:ot,importFromJSON:it,decodePickAt:ke,getRowSurfaceVoxels:ie,getRowAddTargets:at,getPlaneSurfaceVoxels:Ze,getPlaneAddTargets:Q,beginVoxelAction:F,recordVoxelChange:Z,commitAction:W,getSelectedGroupName:mt,setSelectedGroupName:ut,getGroupOverlaysVisible:ft,setGroupOverlaysVisible:pt,FACE_DIRS:st}=d,We=document.getElementById("x"),$e=document.getElementById("y"),qe=document.getElementById("z"),Je=document.getElementById("btnUndo"),Ke=document.getElementById("btnRedo"),Se=document.getElementById("fileInput"),me=document.querySelector(".side-panel"),Fe=document.getElementById("btnToggleMenu"),Ie=document.getElementById("btnCloseMenu");Fe.addEventListener("click",()=>{me.classList.toggle("open")}),Ie.addEventListener("click",()=>{me.classList.remove("open")}),window.addEventListener("keydown",c=>{c.key==="Escape"&&(me.classList.contains("open")&&me.classList.remove("open"),animPanel.classList.contains("open")&&animPanel.classList.remove("open"))}),document.querySelectorAll('input[name="modeSelect"]').forEach(c=>{c.addEventListener("change",a=>{a.target.checked&&J(a.target.value)})}),document.querySelectorAll('input[name="optionSelect"]').forEach(c=>{c.addEventListener("change",a=>{a.target.checked&&ve(a.target.value)})}),document.getElementById("btnImport").addEventListener("click",()=>Se.click()),document.getElementById("btnExport").addEventListener("click",()=>{const c=ot(),a=new Blob([JSON.stringify(c,null,2)],{type:"application/json"}),h=URL.createObjectURL(a),u=document.createElement("a");u.href=h,u.download="voxels.json",u.click(),URL.revokeObjectURL(h)}),Se.addEventListener("change",c=>{const a=c.target.files[0];if(!a)return;const h=new FileReader;h.onload=()=>{try{const u=JSON.parse(h.result);it(u)}catch(u){alert("Invalid JSON: "+u.message)}finally{Se.value=""}},h.readAsText(a)}),document.getElementById("resetSolid").addEventListener("click",()=>{x.resetSize(),x.seedMaterials("bands"),w.reset(),P.target=[8,8,8];const c=d.buildAxisGizmo;c&&c(),tt(),Be(),nt(),He()}),document.getElementById("btnShiftXPos").addEventListener("click",()=>oe(1,0,0)),document.getElementById("btnShiftXNeg").addEventListener("click",()=>oe(-1,0,0)),document.getElementById("btnShiftYPos").addEventListener("click",()=>oe(0,1,0)),document.getElementById("btnShiftYNeg").addEventListener("click",()=>oe(0,-1,0)),document.getElementById("btnShiftZPos").addEventListener("click",()=>oe(0,0,1)),document.getElementById("btnShiftZNeg").addEventListener("click",()=>oe(0,0,-1)),document.getElementById("btnExpandX").addEventListener("click",ce),document.getElementById("btnExpandY").addEventListener("click",le),document.getElementById("btnExpandZ").addEventListener("click",Re),document.getElementById("btnShrinkX").addEventListener("click",j),document.getElementById("btnShrinkY").addEventListener("click",xe),document.getElementById("btnShrinkZ").addEventListener("click",de),document.getElementById("btnCameraXMinus").addEventListener("click",()=>we(-1)),document.getElementById("btnCameraXPlus").addEventListener("click",()=>we(1)),document.getElementById("btnCameraYMinus").addEventListener("click",()=>Ne(-1)),document.getElementById("btnCameraYPlus").addEventListener("click",()=>Ne(1)),document.getElementById("btnCameraZMinus").addEventListener("click",()=>Ve(-1)),document.getElementById("btnCameraZPlus").addEventListener("click",()=>Ve(1)),Je.addEventListener("click",Ce),Ke.addEventListener("click",Ge);function U(){const c=Ae(),a=Te();if(c<0||a<0){We.textContent="-",$e.textContent="-",qe.textContent="-";return}const[h,u,f]=x.coordsOf(c);We.textContent=h,$e.textContent=u,qe.textContent=f}d.updateHoverUI=U,window.addEventListener("keydown",c=>{const a=c.key.toLowerCase();if(a==="q"){document.getElementById("modeCarve").checked=!0,J("carve");return}if(a==="w"){document.getElementById("modeAdd").checked=!0,J("add");return}if(a==="s"){document.getElementById("modePaint").checked=!0,J("paint");return}if(!c.ctrlKey&&a==="v"){document.getElementById("optionVoxel").checked=!0,ve("voxel");return}if(a==="r"){document.getElementById("optionRow").checked=!0,ve("row");return}if(a==="p"){document.getElementById("optionPlane").checked=!0,ve("plane");return}if((c.ctrlKey||c.metaKey)&&!c.shiftKey&&a==="z"){c.preventDefault(),Ce();return}if((c.ctrlKey||c.metaKey)&&(a==="y"||c.shiftKey&&a==="z")){c.preventDefault(),Ge();return}/^[0-9]$/.test(a)?w.selectBrush(parseInt(a,10)):/^[a-f]$/i.test(a)&&w.selectBrush(10+parseInt(a,16)-10),n(!0)}),window.addEventListener("keyup",c=>{n(!0)}),e.addEventListener("contextmenu",c=>c.preventDefault()),e.addEventListener("mousedown",c=>{e.focus();const a=ke(c.clientX,c.clientY),h=te(),u=V();if(a.voxel<0||a.face<0){c.button===0&&(ze(!0),ae(c.clientX),Le(c.clientY));return}if(c.shiftKey&&u==="voxel"&&c.button===0){Y(!0),ge(a.voxel),re(a.voxel,a.face);return}if(c.button===0&&h==="paint"){if(u=="plane"){const f=Ze(a.voxel,a.face);if(f.length>0){const E=F("Paint plane");for(const v of f)Z(E,v,!0,w.getBrush());W(E)}}else if(u=="row"){const f=ie(a.voxel,a.face);if(f.length>0){const E=F("Paint row");for(const v of f)Z(E,v,!0,w.getBrush());W(E)}}else if(a.voxel>=0){const f=x.idx3(...x.coordsOf(a.voxel));if(x.isSolid(f)){const E=F("Paint voxel");Z(E,a.voxel,!0,w.getBrush()),W(E)}}}else if(c.button===0&&h==="add"){if(u=="plane"){const f=Q(a.voxel,a.face);if(f.length>0){const E=F("Add plane");for(const v of f)Z(E,v,!0,w.getBrush());W(E)}}else if(u=="row"){const f=at(a.voxel,a.face);if(f.length>0){const E=F("Add row");for(const v of f)Z(E,v,!0,w.getBrush());W(E)}}else if(a.voxel>=0&&a.face>=0){const[f,E,v]=x.coordsOf(a.voxel),T=st[a.face],L=f+T[0],C=E+T[1],z=v+T[2];if(x.within(L,C,z)){const A=x.idx3(L,C,z);if(!x.isSolid(A)){const I=F("Add voxel");Z(I,A,!0,w.getBrush()),W(I)}}}n(!0)}else if(c.button===0&&h==="carve"){if(u=="plane"){const f=Ze(a.voxel,a.face),E=F("Remove plane");for(const v of f)Z(E,v,!1,x.material(v));W(E)}else if(u=="row"){const f=ie(a.voxel,a.face),E=F("Remove row");for(const v of f)Z(E,v,!1,x.material(v));W(E)}else if(a.voxel>=0&&x.isSolid(a.voxel)){const f=F("Remove voxel");Z(f,a.voxel,!1,x.material(a.voxel)),W(f)}n(!0)}}),window.addEventListener("mouseup",()=>{ze(!1),Y(!1),ge(-1)}),window.addEventListener("mousemove",c=>{const a=ye(),h=_();if(!a&&!h&&(ne(c.clientX),pe(c.clientY),n(!0)),h){const u=ke(c.clientX,c.clientY);u.voxel>=0&&u.face>=0&&u.voxel!==Ee()&&(ge(u.voxel),re(u.voxel,u.face),n(!0))}if(a){const u=k(),f=se(),E=c.clientX-u,v=c.clientY-f;ae(c.clientX),Le(c.clientY);const T=.005;P.theta+=E*T,P.phi-=v*T,P.clamp()}},{passive:!0}),e.addEventListener("wheel",c=>{c.preventDefault();const a=Math.pow(1.1,c.deltaY*.01);P.radius*=a,P.clamp()},{passive:!1});function G(){const c=document.getElementById("animationList");if(c){if(c.innerHTML="",d.animSystem.animations.size===0&&d.animSystem.emitters.size===0&&d.animSystem.sequences.size===0){c.innerHTML='<p style="color: #888; font-size: 12px; margin: 8px 0;">No animations, emitters, or sequences defined</p>';return}if(d.animSystem.animations.size>0){const a=document.createElement("h5");a.textContent="Animations",a.style.margin="8px 0 4px 0",c.appendChild(a)}for(const[a,h]of d.animSystem.animations.entries()){const u=document.createElement("div");u.className="animation-item";const f=document.createElement("div");f.className="animation-info";const E=document.createElement("span");E.className="animation-name",E.textContent=a;const v=document.createElement("span");if(v.className="animation-group",v.textContent=h.regionName||"no region",h.loop){const A=document.createElement("span");A.className="animation-badge",A.textContent="loop",f.appendChild(A)}f.appendChild(E),f.appendChild(v);const T=document.createElement("div");T.className="animation-controls-inline";const L=document.createElement("button");L.textContent="▶",L.title="Play",L.className="animation-btn",L.addEventListener("click",()=>{d.animSystem.playAnimation(a)});const C=document.createElement("button");C.textContent="⏹",C.title="Stop",C.className="animation-btn",C.addEventListener("click",()=>{d.animSystem.stopAnimation(a)});const z=document.createElement("button");z.textContent="↺",z.title="Reset",z.className="animation-btn",z.addEventListener("click",()=>{d.animSystem.resetAnimation(a)}),T.appendChild(L),T.appendChild(C),T.appendChild(z),u.appendChild(f),u.appendChild(T),c.appendChild(u)}if(d.animSystem.emitters.size>0){const a=document.createElement("h5");a.textContent="Emitters",a.style.margin="12px 0 4px 0",c.appendChild(a);for(const[h,u]of d.animSystem.emitters.entries()){const f=document.createElement("div");f.className="animation-item";const E=document.createElement("div");E.className="animation-info";const v=document.createElement("span");v.className="animation-name",v.textContent=h;const T=document.createElement("span");T.className="animation-region",T.textContent=u.enabled?"active":"stopped";const L=document.createElement("span");L.className="animation-badge",L.textContent=`${u.particles.length} particles`,E.appendChild(v),E.appendChild(L),E.appendChild(T);const C=document.createElement("div");C.className="animation-controls-inline";const z=document.createElement("button");z.textContent="▶",z.title="Start",z.className="animation-btn",z.addEventListener("click",()=>{d.animSystem.startEmitter(h)});const A=document.createElement("button");A.textContent="⏹",A.title="Stop",A.className="animation-btn",A.addEventListener("click",()=>{d.animSystem.stopEmitter(h)});const I=document.createElement("button");I.textContent="✕",I.title="Clear particles",I.className="animation-btn",I.addEventListener("click",()=>{d.animSystem.clearEmitter(h)}),C.appendChild(z),C.appendChild(A),C.appendChild(I),f.appendChild(E),f.appendChild(C),c.appendChild(f)}}if(d.animSystem.sequences.size>0){const a=document.createElement("h5");a.textContent="Sequences",a.style.margin="12px 0 4px 0",c.appendChild(a);for(const[h,u]of d.animSystem.sequences.entries()){const f=document.createElement("div");f.className="animation-item";const E=document.createElement("div");E.className="animation-info";const v=document.createElement("span");v.className="animation-name",v.textContent=h;const T=document.createElement("span");T.className="animation-badge";const L=u.animationNames.length+u.emitterNames.length;T.textContent=`${L} items`;const C=document.createElement("span");C.className="animation-group";const z=[];u.animationNames.length>0&&z.push(`${u.animationNames.length} anim${u.animationNames.length!==1?"s":""}`),u.emitterNames.length>0&&z.push(`${u.emitterNames.length} emitter${u.emitterNames.length!==1?"s":""}`),C.textContent=z.join(", "),E.appendChild(v),E.appendChild(T),E.appendChild(C);const A=document.createElement("div");A.className="animation-controls-inline";const I=document.createElement("button");I.textContent="▶",I.title="Play sequence",I.className="animation-btn",I.addEventListener("click",()=>{d.animSystem.playSequence(h)});const $=document.createElement("button");$.textContent="⏹",$.title="Stop sequence",$.className="animation-btn",$.addEventListener("click",()=>{d.animSystem.stopSequence(h)});const N=document.createElement("button");N.textContent="↺",N.title="Reset sequence",N.className="animation-btn",N.addEventListener("click",()=>{d.animSystem.resetSequence(h)}),A.appendChild(I),A.appendChild($),A.appendChild(N),f.appendChild(E),f.appendChild(A),c.appendChild(f)}}}}function Me(){const c=document.getElementById("regionList");if(!c)return;if(c.innerHTML="",d.animSystem.regions.size===0){c.innerHTML='<p style="color: #888; font-size: 12px; margin: 8px 0;">No regions defined</p>';return}const a=d.getGroupOverlaysVisible(),h=d.getSelectedGroupName();for(const[u,f]of d.animSystem.regions.entries()){const E=document.createElement("div");E.className="region-item",h===u&&E.classList.add("selected");const v=document.createElement("div");v.className="region-header";const T=document.createElement("span");T.className="region-name",T.textContent=u;const L=document.createElement("div");L.className="region-toggle";const C=document.createElement("input");C.type="checkbox",C.id=`region-vis-${u}`,C.checked=a.get(u)||!1,C.addEventListener("change",ee=>{a.set(u,ee.target.checked),ee.target.checked&&(d.setSelectedGroupName(u),Me())});const z=document.createElement("label");z.htmlFor=`region-vis-${u}`,z.textContent="Show",L.appendChild(C),L.appendChild(z),v.appendChild(T),v.appendChild(L);const A=document.createElement("div");A.className="region-bounds";const I=document.createElement("div");I.className="bounds-col";const $=document.createElement("div");$.className="bounds-label",$.textContent="Min",I.appendChild($),["x","y","z"].forEach((ee,ue)=>{const q=document.createElement("div");q.className="bounds-row";const fe=document.createElement("label");fe.textContent=ee.toUpperCase();const X=document.createElement("input");X.type="number",X.min="0",X.max="15",X.value=f.min[ue],X.addEventListener("change",t=>{const o=Math.max(0,Math.min(15,parseInt(t.target.value)||0));f.min[ue]=o,t.target.value=o,d.chunk.clearGroups(),d.animSystem.regions.forEach((r,i)=>{d.chunk.addGroup(i,r.min,r.max)}),d.animSystem.assignVoxelsToGroups(d.chunk),d.buildAllMeshes()}),q.appendChild(fe),q.appendChild(X),I.appendChild(q)});const N=document.createElement("div");N.className="bounds-col";const he=document.createElement("div");he.className="bounds-label",he.textContent="Max",N.appendChild(he),["x","y","z"].forEach((ee,ue)=>{const q=document.createElement("div");q.className="bounds-row";const fe=document.createElement("label");fe.textContent=ee.toUpperCase();const X=document.createElement("input");X.type="number",X.min="0",X.max="15",X.value=f.max[ue],X.addEventListener("change",t=>{const o=Math.max(0,Math.min(15,parseInt(t.target.value)||0));f.max[ue]=o,t.target.value=o,d.chunk.clearGroups(),d.animSystem.regions.forEach((r,i)=>{d.chunk.addGroup(i,r.min,r.max)}),d.animSystem.assignVoxelsToGroups(d.chunk),d.buildAllMeshes()}),q.appendChild(fe),q.appendChild(X),N.appendChild(q)}),A.appendChild(I),A.appendChild(N),E.appendChild(v),E.appendChild(A),c.appendChild(E)}}document.getElementById("btnCompile")?.addEventListener("click",()=>{const c=document.getElementById("animationDSL").value;try{d.animSystem.parse(c),d.animSystem.assignVoxelsToGroups(d.chunk),d.chunk.clearGroups(),d.animSystem.regions.forEach((a,h)=>{d.chunk.addGroup(h,a.min,a.max)}),d.buildAllMeshes(),G(),Me()}catch(a){console.error("Animation compile error:",a),alert("Animation compile error: "+a.message)}}),document.getElementById("btnPlay")?.addEventListener("click",()=>{for(const[c,a]of d.animSystem.animations.entries())a.loop&&d.animSystem.playAnimation(c);for(const[c,a]of d.animSystem.emitters.entries())d.animSystem.startEmitter(c)}),document.getElementById("btnPause")?.addEventListener("click",()=>{for(const c of d.animSystem.animations.values())c.stop();for(const c of d.animSystem.emitters.values())c.stop()}),document.getElementById("btnResetAll")?.addEventListener("click",()=>{d.animSystem.resetAll()})}function Mt(){const d=document.getElementById("gl"),e=d.getContext("webgl2",{antialias:!0,alpha:!1});if(!e){alert("WebGL2 not supported");return}e.enable(e.DEPTH_TEST),e.enable(e.CULL_FACE),e.cullFace(e.BACK);const x=_e(e,Tt,St);x.meta.visible=!0,x.meta.regions={};const O=_e(e,Lt,zt),w=_e(e,wt,Bt),P=_e(e,Rt,Ct),M=_e(e,kt,Nt),Pe=gt();e.bindVertexArray(w.vao),e.bindBuffer(e.ARRAY_BUFFER,e.createBuffer()),e.bufferData(e.ARRAY_BUFFER,Pe.positions,e.STATIC_DRAW),e.enableVertexAttribArray(w.aPosition.location),e.vertexAttribPointer(w.aPosition.location,3,e.FLOAT,!1,0,0),e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,e.createBuffer()),e.bufferData(e.ELEMENT_ARRAY_BUFFER,Pe.indices,e.STATIC_DRAW),e.bindVertexArray(null);function te(){const t=bt(n.sizeX,n.sizeZ);e.bindVertexArray(P.vao),e.bindBuffer(e.ARRAY_BUFFER,e.createBuffer()),e.bufferData(e.ARRAY_BUFFER,t.positions,e.STATIC_DRAW),e.enableVertexAttribArray(P.aPosition.location),e.vertexAttribPointer(P.aPosition.location,3,e.FLOAT,!1,0,0),e.bindBuffer(e.ARRAY_BUFFER,e.createBuffer()),e.bufferData(e.ARRAY_BUFFER,t.colors,e.STATIC_DRAW),e.enableVertexAttribArray(P.aColor.location),e.vertexAttribPointer(P.aColor.location,3,e.FLOAT,!1,0,0),e.bindVertexArray(null),P.meta.count=t.count}const J=xt();if(e.bindVertexArray(M.vao),M.aPosition&&(e.bindBuffer(e.ARRAY_BUFFER,e.createBuffer()),e.bufferData(e.ARRAY_BUFFER,J.positions,e.STATIC_DRAW),e.enableVertexAttribArray(M.aPosition.location),e.vertexAttribPointer(M.aPosition.location,3,e.FLOAT,!1,0,0)),M.aNormal&&(e.bindBuffer(e.ARRAY_BUFFER,e.createBuffer()),e.bufferData(e.ARRAY_BUFFER,J.normals,e.STATIC_DRAW),e.enableVertexAttribArray(M.aNormal.location),e.vertexAttribPointer(M.aNormal.location,3,e.FLOAT,!1,0,0)),M.aMatId){const t=new Uint8Array(J.positions.length/3);e.bindBuffer(e.ARRAY_BUFFER,e.createBuffer()),e.bufferData(e.ARRAY_BUFFER,t,e.STATIC_DRAW),e.enableVertexAttribArray(M.aMatId.location),e.vertexAttribIPointer(M.aMatId.location,1,e.UNSIGNED_BYTE,0,0)}e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,e.createBuffer()),e.bufferData(e.ELEMENT_ARRAY_BUFFER,J.indices,e.STATIC_DRAW),e.bindVertexArray(null);const V=new yt;let ve=new Map,Ae=0,Ue=null,Te=new Map,D=16;const n=new ht(D),ye=[[1,0,0],[-1,0,0],[0,1,0],[0,-1,0],[0,0,1],[0,0,-1],[0,0,0]],ze=[{axis:0,u:2,v:1},{axis:0,u:2,v:1},{axis:1,u:0,v:2},{axis:1,u:0,v:2},{axis:2,u:0,v:1},{axis:2,u:0,v:1}];n.seedMaterials("bands"),te();const k=new vt({target:[8,8,8],radius:40,theta:Et(215),phi:Et(60)}),ae=je.identity();let se=je.perspective(60*Math.PI/180,1,.01,100);const Le=.22;let Xe=1,ne=null,be=null,pe=null,De=0,Ye=0;function ct(){const t=d.width,o=d.height;t===De&&o===Ye&&ne||(be&&e.deleteTexture(be),pe&&e.deleteRenderbuffer(pe),ne&&e.deleteFramebuffer(ne),be=e.createTexture(),e.bindTexture(e.TEXTURE_2D,be),e.texImage2D(e.TEXTURE_2D,0,e.RGBA8,t,o,0,e.RGBA,e.UNSIGNED_BYTE,null),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),pe=e.createRenderbuffer(),e.bindRenderbuffer(e.RENDERBUFFER,pe),e.renderbufferStorage(e.RENDERBUFFER,e.DEPTH_COMPONENT16,t,o),ne=e.createFramebuffer(),e.bindFramebuffer(e.FRAMEBUFFER,ne),e.framebufferTexture2D(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.TEXTURE_2D,be,0),e.framebufferRenderbuffer(e.FRAMEBUFFER,e.DEPTH_ATTACHMENT,e.RENDERBUFFER,pe),e.bindFramebuffer(e.FRAMEBUFFER,null),De=t,Ye=o)}function Oe(){Xe=Math.max(1,Math.min(2,window.devicePixelRatio||1));const t=d.clientWidth||d.parentElement.clientWidth,o=d.clientHeight||d.parentElement.clientHeight;d.width=Math.round(t*Xe),d.height=Math.round(o*Xe),e.viewport(0,0,d.width,d.height),se=je.perspective(60*Math.PI/180,d.width/d.height,.01,100),ct()}window.addEventListener("resize",Oe,{passive:!0}),requestAnimationFrame(Oe);function lt(){e.bindFramebuffer(e.FRAMEBUFFER,ne),e.viewport(0,0,De,Ye),e.clearColor(0,0,0,1),e.clear(e.COLOR_BUFFER_BIT|e.DEPTH_BUFFER_BIT);const t=e.isEnabled(e.CULL_FACE);t&&e.disable(e.CULL_FACE),e.useProgram(O.program),O.uModel.set(ae),O.uView.set(k.view()),O.uProj.set(se),e.bindVertexArray(O.vao),e.drawElements(e.TRIANGLES,O.meta.pickVoxelCount,e.UNSIGNED_INT,0),_==="add"&&(e.bindVertexArray(O.vaoGround),e.drawElements(e.TRIANGLES,O.meta.pickGroundCount,e.UNSIGNED_INT,0)),e.bindVertexArray(null),t&&e.enable(e.CULL_FACE),e.bindFramebuffer(e.FRAMEBUFFER,null)}function dt(t,o){const r=d.getBoundingClientRect(),i=Math.floor((t-r.left)*(d.width/r.width)),s=Math.floor((r.height-(o-r.top))*(d.height/r.height));return{x:i,y:s}}function Qe(t,o){if(O.meta.pickVoxelCount===0&&O.meta.pickGroundCount===0)return{voxel:-1,face:-1};lt();const{x:r,y:i}=dt(t,o),s=new Uint8Array(4);e.bindFramebuffer(e.FRAMEBUFFER,ne),e.readPixels(r,i,1,1,e.RGBA,e.UNSIGNED_BYTE,s),e.bindFramebuffer(e.FRAMEBUFFER,null);const m=s[0]|s[1]<<8|s[2]<<16;if(m===0)return{voxel:-1,face:-1};const l=m&7,g=(m>>4)-1;return g<0||g>=n.length?{voxel:-1,face:-1}:{voxel:g,face:l}}function et(t,o,r,i,s,m,l,g=1.006){const y=i-t+1,b=s-o+1,R=m-r+1,S=t+y*.5,B=o+b*.5,p=r+R*.5;e.useProgram(w.program),w.uModel.set(ae),w.uView.set(k.view()),w.uProj.set(se),w.uOffset.set(new Float32Array([S,B,p])),w.uScaleVec.set(new Float32Array([y,b,R])),w.uInflate.set(g),w.uColor.set(new Float32Array(l)),e.bindVertexArray(w.vao),e.drawElements(e.LINES,Pe.count,e.UNSIGNED_SHORT,0),e.bindVertexArray(null)}function K(t,o,r=1.006){const[i,s,m]=n.coordsOf(t);et(i,s,m,i,s,m,o,r)}const H=new At(document.getElementById("palette"),t=>{},(t,o,r)=>{const i=ot(`Palette ${t}`);it(i,t,o,r),ie(i,!1)});let _=document.querySelector('input[name="modeSelect"]:checked').value,Y=document.querySelector('input[name="optionSelect"]:checked').value;function Ee(t){return t>=0&&t<=9?String.fromCharCode(48+t):t>=10&&t<=15?String.fromCharCode(97+(t-10)):"0"}function ge(t){return Math.max(0,Math.min(255,t)).toString(16).padStart(2,"0")}function tt(){const t=[];for(let s=0;s<16;s++)t.push(Ft(H.colors[s*3+0],H.colors[s*3+1],H.colors[s*3+2]));const o=[],i=Math.max(n.sizeX,n.sizeY,n.sizeZ)<=16;for(let s=0;s<n.sizeZ;s++)for(let m=0;m<n.sizeY;m++)for(let l=0;l<n.sizeX;l++){const g=n.idx3(l,m,s);n.isSolid(g)&&(i?o.push(`${Ee(l)}${Ee(m)}${Ee(s)}${Ee(n.material(g))}`):o.push(`${ge(l)}${ge(m)}${ge(s)}${Ee(n.material(g))}`))}return Object.assign({version:1,size:[n.sizeX,n.sizeY,n.sizeZ],palette:t,voxels:o},V.toJSON())}function re(t){const o=t.toLowerCase();return o>="0"&&o<="9"?o.charCodeAt(0)-48:o>="a"&&o<="f"?10+(o.charCodeAt(0)-97):0}function Be(t){return parseInt(t,16)||0}function nt(t){if(!t||typeof t!="object")throw new Error("Root must be object");if(!Array.isArray(t.voxels))throw new Error('Missing "voxels"');let o,r,i;if(Array.isArray(t.size)){if(t.size.length!==3)throw new Error("Size array must have 3 elements [x, y, z]");[o,r,i]=t.size}else if(typeof t.size=="number")o=r=i=t.size;else throw new Error('Invalid "size" field');if(o===16&&r===16&&i===16?n.resetSize():(n.resetSize(),n.expandSize(o,r,i)),D=Math.max(o,r,i),k.target=[o/2,r/2,i/2],te(),Array.isArray(t.palette))for(let s=0;s<Math.min(16,t.palette.length);s++){const m=t.palette[s];let l;typeof m=="string"?l=rt(m):Array.isArray(m)&&m.length>=3&&(l=[+m[0],+m[1],+m[2]]),l&&H.setPaletteColor(s,[Math.max(0,Math.min(1,l[0])),Math.max(0,Math.min(1,l[1])),Math.max(0,Math.min(1,l[2]))])}n.fill(!1),n.setMaterialAll(0);for(const s of t.voxels){if(!s)continue;let m,l,g,y;if(typeof s=="string")if(s.length===4)m=re(s[0]),l=re(s[1]),g=re(s[2]),y=(re(s[3])|0)&15;else if(s.length===7)m=Be(s.substring(0,2)),l=Be(s.substring(2,4)),g=Be(s.substring(4,6)),y=(re(s[6])|0)&15;else continue;else if(Array.isArray(s)&&s.length>=4)[m,l,g,y]=s;else continue;if(n.within(m,l,g)){const b=n.idx3(m,l,g);n.setSolid(b,!0),n.setMaterial(b,y)}}A(),Q(),F(),t.regions&&V.fromJSON(t),j()}const we=[{axis:0,u:2,v:1},{axis:0,u:2,v:1},{axis:1,u:0,v:2},{axis:1,u:0,v:2},{axis:2,u:0,v:1},{axis:2,u:0,v:1},{axis:1,u:0,v:2}];function Ne(t,o){if(t<0||o<0||o>we.length)return[];const r=we[o],[i,s,m]=n.coordsOf(t),l=r.u,g=r.v,y=r.axis,b=[i,s,m][l],R=[i,s,m][g],S=[];for(let B=0;B<D;B++){const p=[0,0,0];p[l]=b,p[g]=R,p[y]=B,n.within(p[0],p[1],p[2])&&n.isSolid(n.idx3(p[0],p[1],p[2]))&&S.push(n.idx3(p[0],p[1],p[2]))}return S}const Ve=[{axis:0,u:2,v:1},{axis:0,u:2,v:1},{axis:1,u:0,v:2},{axis:1,u:0,v:2},{axis:2,u:0,v:1},{axis:2,u:0,v:1},{axis:1,u:0,v:2}];function He(t,o){if(t<0||o<0)return[];const r=Ve[o],[i,s,m]=n.coordsOf(t),l=r.u,g=r.v,y=r.axis,b=[i,s,m][l],R=[i,s,m][g],S=[];for(let B=0;B<D;B++){const p=[0,0,0];p[l]=b,p[g]=R,p[y]=B,n.within(p[0],p[1],p[2])&&(n.isSolid(n.idx3(p[0],p[1],p[2]))||S.push(n.idx3(p[0],p[1],p[2])))}return S}function Ce(t,o){if(t<0||o<0||o>=ze.length)return[];const r=ze[o],[i,s,m]=n.coordsOf(t),l=r.axis,g=r.u,y=r.v,b=[i,s,m][l],R=[];for(let S=0;S<D;S++)for(let B=0;B<D;B++){const p=[0,0,0];if(p[l]=b,p[g]=S,p[y]=B,o==6){if(!n.within(p[0],p[1],p[2])||!n.isSolid(n.idx3(p[0],p[1],p[2])))continue;R.push(n.idx3(p[0],p[1],p[2]));continue}n.within(p[0],p[1],p[2])&&n.isSolid(n.idx3(p[0],p[1],p[2]))&&n.faceExposed(p[0],p[1],p[2],o)&&R.push(n.idx3(p[0],p[1],p[2]))}return R}function Ge(){const t=[];for(let o=0;o<n.sizeX;o++)for(let r=0;r<n.sizeZ;r++)t.push(n.idx3(o,0,r));return t}function oe(t,o){const r=ye[o],i=o===6?Ge():Ce(t,o),s=new Set;for(const l of i){const[g,y,b]=n.coordsOf(l),R=g+r[0],S=y+r[1],B=b+r[2];n.within(R,S,B)&&!n.isSolid(n.idx3(R,S,B))&&s.add(n.idx3(R,S,B))}return[...s]}const ce=[],le=[];function Re(){const t=document.getElementById("btnUndo"),o=document.getElementById("btnRedo");t.disabled=ce.length===0,o.disabled=le.length===0}function j(){ce.length=0,le.length=0,Re()}function xe(t){return{type:"voxels",label:t,vox:[]}}function de(t,o,r,i=n.material(o)){const s=n.isSolid(o),m=n.material(o);s===r&&m===i||(t.vox.push({idx:o,fromS:s,fromM:m,toS:r,toM:i}),n.setSolid(o,r),n.setMaterial(o,i))}function ot(t){return{type:"palette",label:t,pal:[]}}function it(t,o,r,i){const s=rt(r),m=rt(i);r!==i&&t.pal.push({i:o,from:s,to:m})}function ke(t,o){if(t.type==="voxels"){const r=t.vox;if(o==="undo")for(const i of r)n.setSolid(i.idx,i.fromS),n.setMaterial(i.idx,i.fromM);else for(const i of r)n.setSolid(i.idx,i.toS),n.setMaterial(i.idx,i.toM)}else if(t.type==="palette"){const r=t.pal;if(o==="undo")for(const i of r)H.setPaletteColor(i.i,i.from);else for(const i of r)H.setPaletteColor(i.i,i.to)}}function ie(t,o=!0){t.type==="voxels"&&t.vox.length===0||t.type==="palette"&&(!t.pal||t.pal.length===0)||(ce.push(t),le.length=0,Re(),t.type==="voxels"&&o&&A())}function at(){if(ce.length===0)return;const t=ce.pop();ke(t,"undo"),le.push(t),Re(),t.type==="voxels"&&A()}function Ze(){if(le.length===0)return;const t=le.pop();ke(t,"do"),ce.push(t),Re(),t.type==="voxels"&&A()}function Q(){document.getElementById("sizeX").textContent=n.sizeX,document.getElementById("sizeY").textContent=n.sizeY,document.getElementById("sizeZ").textContent=n.sizeZ}function F(){document.getElementById("cameraX").textContent=Math.round(k.target[0]),document.getElementById("cameraY").textContent=Math.round(k.target[1]),document.getElementById("cameraZ").textContent=Math.round(k.target[2])}function Z(t){k.target[0]+=t,F()}function W(t){k.target[1]+=t,F()}function mt(t){k.target[2]+=t,F()}function ut(){const t=n.sizeX+1;n.expandSize(t,n.sizeY,n.sizeZ),D=Math.max(n.sizeX,n.sizeY,n.sizeZ),k.target=[n.sizeX/2,n.sizeY/2,n.sizeZ/2],te(),A(),Q(),F(),j()}function ft(){const t=n.sizeY+1;n.expandSize(n.sizeX,t,n.sizeZ),D=Math.max(n.sizeX,n.sizeY,n.sizeZ),k.target=[n.sizeX/2,n.sizeY/2,n.sizeZ/2],A(),Q(),F(),j()}function pt(){const t=n.sizeZ+1;n.expandSize(n.sizeX,n.sizeY,t),D=Math.max(n.sizeX,n.sizeY,n.sizeZ),k.target=[n.sizeX/2,n.sizeY/2,n.sizeZ/2],te(),A(),Q(),F(),j()}function st(){if(n.sizeX<=1)return;const t=n.sizeX-1;n.expandSize(t,n.sizeY,n.sizeZ),D=Math.max(n.sizeX,n.sizeY,n.sizeZ),k.target=[n.sizeX/2,n.sizeY/2,n.sizeZ/2],te(),A(),Q(),F(),j()}function We(){if(n.sizeY<=1)return;const t=n.sizeY-1;n.expandSize(n.sizeX,t,n.sizeZ),D=Math.max(n.sizeX,n.sizeY,n.sizeZ),k.target=[n.sizeX/2,n.sizeY/2,n.sizeZ/2],A(),Q(),F(),j()}function $e(){if(n.sizeZ<=1)return;const t=n.sizeZ-1;n.expandSize(n.sizeX,n.sizeY,t),D=Math.max(n.sizeX,n.sizeY,n.sizeZ),k.target=[n.sizeX/2,n.sizeY/2,n.sizeZ/2],te(),A(),Q(),F(),j()}function qe(t,o,r){const i=xe(`Shift ${t!==0?t>0?"+X":"-X":o!==0?o>0?"+Y":"-Y":r>0?"+Z":"-Z"}`),s=new Array(n.length),m=new Uint8Array(n.length);for(let l=0;l<n.length;l++)s[l]=n.isSolid(l),m[l]=n.material(l);for(let l=0;l<n.length;l++)n.setSolid(l,!1),n.setMaterial(l,0);for(let l=0;l<n.sizeZ;l++)for(let g=0;g<n.sizeY;g++)for(let y=0;y<n.sizeX;y++){const b=n.idx3(y,g,l);if(!s[b])continue;const R=y+t,S=g+o,B=l+r;if(n.within(R,S,B)){const p=n.idx3(R,S,B);de(i,p,!0,m[b])}else de(i,b,!1,m[b])}for(const l of V.regions.values())l.min[0]+=t,l.min[1]+=o,l.min[2]+=r,l.max[0]+=t,l.max[1]+=o,l.max[2]+=r;for(const l of V.animations.values())for(const g of l.keyframes)g.type==="rotate"&&g.pivot&&(g.pivot[0]+=t,g.pivot[1]+=o,g.pivot[2]+=r);ie(i,!0)}let Je=!1,Ke=0,Se=0,me=0,Fe=0,Ie=!0,U=-1,G=-1,Me=!1,c=-1,a=[],h=[],u=[],f=[],E=()=>{};function v(t,o){if(t<0||o<0)return;const r=_,i=Y;if(r==="paint"){if(i==="voxel"&&n.isSolid(t)){const s=xe("Paint voxel");de(s,t,!0,H.getBrush()),ie(s)}}else if(r==="add"){if(i==="voxel"){const[s,m,l]=n.coordsOf(t),g=ye[o],y=s+g[0],b=m+g[1],R=l+g[2];if(n.within(y,b,R)){const S=n.idx3(y,b,R);if(!n.isSolid(S)){const B=xe("Add voxel");de(B,S,!0,H.getBrush()),ie(B)}}}}else if(r==="carve"&&i==="voxel"&&n.isSolid(t)){const s=xe("Remove voxel");de(s,t,!1,n.material(t)),ie(s)}}function T(){if(!Ie)return;Ie=!1;const t=Qe(me,Fe);U=t.voxel,G=t.face,E(),U>=0&&G>=0?(_==="add"&&Y==="row"?h=He(U,G):h=[],_!=="add"&&Y==="row"?a=Ne(U,G):a=[],_==="add"&&Y==="plane"?f=oe(U,G):f=[],_!=="add"&&Y==="plane"?u=Ce(U,G):u=[]):(a=[],h=[],u=[],f=[])}const L=[1,.6,.2],C=[1,.32,.32],z=[.27,.95,.42];function A(){x.meta.renderIndexCount=n.buildGreedyRenderMeshMain(e,x,x.vao),n.buildPickFaces(e,O),x.meta.regions={};for(const[t,o]of V.regions.entries())x.meta.regions[t]={},x.meta.regions[t].vao=e.createVertexArray(),x.meta.regions[t].visible=!0,x.meta.regions[t].indexCount=n.buildGreedyRenderMeshRegion(e,x,x.meta.regions[t].vao,t)}A();const I=1e3,$=2,N=64,he=Math.ceil(I*$/N),ee=e.createTexture();e.bindTexture(e.TEXTURE_2D,ee),e.texImage2D(e.TEXTURE_2D,0,e.RGBA32F,N,he,0,e.RGBA,e.FLOAT,null),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE);const ue=e.getError();ue!==e.NO_ERROR&&console.error("Texture creation error:",ue);function q(t){const o=new Float32Array(N*he*4);for(let r=0;r<t.length;r++){const i=t[r],s=r*2,m=r*2+1,l=s%N,g=Math.floor(s/N),y=m%N,b=Math.floor(m/N),R=(g*N+l)*4,S=(b*N+y)*4;o[R+0]=i.position[0],o[R+1]=i.position[1],o[R+2]=i.position[2],o[R+3]=i.size,o[S+0]=i.color/255,o[S+1]=i.getAlpha(),o[S+2]=0,o[S+3]=0}e.bindTexture(e.TEXTURE_2D,ee),e.texSubImage2D(e.TEXTURE_2D,0,0,0,N,he,e.RGBA,e.FLOAT,o)}function fe(){const t=performance.now(),o=(t-Ae)/1e3;Ae=t,V.update(o),e.clearColor(.07,.08,.1,1),e.clear(e.COLOR_BUFFER_BIT|e.DEPTH_BUFFER_BIT),e.useProgram(x.program),x.uPalette.set(H.colors),x.uView.set(k.view()),x.uProj.set(se),x.uNormalMat.set(new Float32Array([1,0,0,0,1,0,0,0,1])),x.uLightDirWS.set(new Float32Array([.7/1.7,-1.2/1.7,.9/1.7])),x.uAmbient.set(Le),x.meta.visible&&(x.uModel.set(ae),e.bindVertexArray(x.vao),e.drawElements(e.TRIANGLES,x.meta.renderIndexCount,e.UNSIGNED_INT,0),e.bindVertexArray(null)),Object.keys(x.meta.regions).forEach(i=>{const s=x.meta.regions[i];if(!s.visible)return;const m=V.getRegionTransform(i),l=je.multiply(ae,m);x.uModel.set(l),e.bindVertexArray(s.vao),e.drawElements(e.TRIANGLES,s.indexCount,e.UNSIGNED_INT,0),e.bindVertexArray(null)}),e.useProgram(P.program),P.uModel.set(ae),P.uView.set(k.view()),P.uProj.set(se),e.bindVertexArray(P.vao),e.drawArrays(e.LINES,0,P.meta.count),e.bindVertexArray(null);const r=V.getAllParticles();if(r.length>0){e.enable(e.BLEND),e.blendFunc(e.SRC_ALPHA,e.ONE_MINUS_SRC_ALPHA),e.useProgram(M.program),M.uPalette.set(H.colors),M.uView.set(k.view()),M.uProj.set(se),M.uLightDirWS.set(new Float32Array([.7/1.7,-1.2/1.7,.9/1.7])),M.uAmbient.set(Le),q(r),e.activeTexture(e.TEXTURE0),e.bindTexture(e.TEXTURE_2D,ee),M.uParticleData.set(0),M.uTextureWidth.set(N),e.bindVertexArray(M.vao),e.drawElementsInstanced(e.TRIANGLES,J.count,e.UNSIGNED_SHORT,0,r.length);const i=e.getError();i!==e.NO_ERROR&&console.error("Draw error:",i,"hex:",i.toString(16)),e.bindVertexArray(null),e.disable(e.BLEND)}if(T(),_!=="move"&&U>=0&&G>=0){if(Y==="plane"){if(_==="add")for(const i of f)K(i,z,1.006);else if(_==="carve")for(const i of u)K(i,C,1.006);else if(_==="paint")for(const i of u)K(i,L,1.006)}else if(Y==="row"){if(_==="add")for(const i of h)K(i,z,1.006);else if(_==="carve")for(const i of a)K(i,C,1.006);else if(_==="paint")for(const i of a)K(i,L,1.006)}else if(Y==="voxel"){if(_==="add"){const[i,s,m]=n.coordsOf(U),l=ye[G],g=i+l[0],y=s+l[1],b=m+l[2];n.within(g,y,b)&&!n.isSolid(n.idx3(g,y,b))&&K(n.idx3(g,y,b),z,1.006)}else if(_==="carve"){const[i,s,m]=n.coordsOf(U),l=n.idx3(i,s,m);n.isSolid(l)&&K(U,C,1.006)}else if(_==="paint"){const[i,s,m]=n.coordsOf(U),l=n.idx3(i,s,m);n.isSolid(l)&&K(U,L,1.006)}}}for(const[i,s]of V.regions.entries())if(Te.get(i)){const[m,l,g]=s.min,[y,b,R]=s.max;et(m,l,g,y,b,R,Ue===i?[.2,.6,1]:[.6,.8,.3],1.01)}requestAnimationFrame(fe)}requestAnimationFrame(fe),setTimeout(Oe,0);const X={canvas:d,chunk:n,N:D,palette:H,camera:k,animSystem:V,animationTransforms:ve,getMode:()=>_,setMode:t=>{_=t},getOption:()=>Y,setOption:t=>{Y=t},getHoverVoxel:()=>U,setHoverVoxel:t=>{U=t},getHoverFace:()=>G,setHoverFace:t=>{G=t},setNeedsPick:t=>{Ie=t},getDragging:()=>Je,setDragging:t=>{Je=t},getLastX:()=>Ke,setLastX:t=>{Ke=t},getLastY:()=>Se,setLastY:t=>{Se=t},getMouseX:()=>me,setMouseX:t=>{me=t},getMouseY:()=>Fe,setMouseY:t=>{Fe=t},getLastTime:()=>Ae,setLastTime:t=>{Ae=t},getRowHoverSurf:()=>a,setRowHoverSurf:t=>{a=t},getRowHoverAdd:()=>h,setRowHoverAdd:t=>{h=t},getPlaneHoverSurf:()=>u,setPlaneHoverSurf:t=>{u=t},getPlaneHoverAdd:()=>f,setPlaneHoverAdd:t=>{f=t},getSelectedRegionName:()=>Ue,setSelectedRegionName:t=>{Ue=t},getRegionOverlaysVisible:()=>Te,setRegionOverlaysVisible:t=>{Te=t},getContinuousMode:()=>Me,setContinuousMode:t=>{Me=t},getLastAppliedVoxel:()=>c,setLastAppliedVoxel:t=>{c=t},buildAllMeshes:A,applyToolAt:v,buildAxisGizmo:te,updateChunkSizeUI:Q,updateCameraTargetUI:F,moveCameraTargetX:Z,moveCameraTargetY:W,moveCameraTargetZ:mt,clearHistory:j,undo:at,redo:Ze,shiftVoxels:qe,expandChunkX:ut,expandChunkY:ft,expandChunkZ:pt,shrinkChunkX:st,shrinkChunkY:We,shrinkChunkZ:$e,exportToJSON:tt,importFromJSON:nt,decodePickAt:Qe,getRowSurfaceVoxels:Ne,getRowAddTargets:He,getPlaneSurfaceVoxels:Ce,getPlaneAddTargets:oe,beginVoxelAction:xe,recordVoxelChange:de,commitAction:ie,FACE_DIRS:ye};It(X),E=X.updateHoverUI}document.addEventListener("DOMContentLoaded",Mt);

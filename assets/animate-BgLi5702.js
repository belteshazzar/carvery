import{c as we,l as ze,f as Oe,p as Ve,g as Ge,w as Xe,i as He,d as Ye,e as $e,j as We,k as qe,m as Je,a as je,V as Ze,O as Ke,t as De,M as _e,P as Qe,b as et,A as tt,h as nt,r as at}from"./voxel-chunk-C2aVMRXz.js";function ot(a){const{canvas:e,chunk:M,N:re,palette:oe,camera:te,animSystem:q,animationTransforms:Fe,getHoverVoxel:Re,getHoverFace:fe,setNeedsPick:le,getDragging:Me,setDragging:Ae,getLastX:Se,setLastX:ye,getLastY:Le,setLastY:N,setMouseX:me,setMouseY:he,exportToJSON:de,importFromJSON:Be,decodePickAt:Te}=a,se=document.getElementById("x"),pe=document.getElementById("y"),ue=document.getElementById("z"),ge=document.getElementById("fileInput"),be=document.querySelector(".side-panel");window.addEventListener("keydown",c=>{c.key==="Escape"&&(be.classList.contains("open")&&be.classList.remove("open"),animPanel.classList.contains("open")&&animPanel.classList.remove("open"))}),document.getElementById("btnImport").addEventListener("click",()=>ge.click()),document.getElementById("btnExport").addEventListener("click",()=>{const c=de(),b=new Blob([JSON.stringify(c,null,2)],{type:"application/json"}),p=URL.createObjectURL(b),o=document.createElement("a");o.href=p,o.download="voxels.json",o.click(),URL.revokeObjectURL(p)}),ge.addEventListener("change",c=>{const b=c.target.files[0];if(!b)return;const p=new FileReader;p.onload=()=>{try{const o=JSON.parse(p.result);console.log("Importing JSON:",o),Be(o),Z(),Ee(),ae(),ie();const t=document.querySelector(".animation-panel");t&&t.setAttribute("data-loaded","true")}catch(o){alert("Invalid JSON: "+o.message),console.error("Error importing JSON:",o)}finally{ge.value=""}},p.readAsText(b)});function Ie(){const c=Re(),b=fe();if(c<0||b<0){se.textContent="-",pe.textContent="-",ue.textContent="-";return}const[p,o,t]=M.coordsOf(c);se.textContent=p,pe.textContent=o,ue.textContent=t}a.updateHoverUI=Ie,e.addEventListener("contextmenu",c=>c.preventDefault()),e.addEventListener("mousedown",c=>{e.focus();const b=Te(c.clientX,c.clientY);if(b.voxel<0||b.face<0){c.button===0&&(Ae(!0),ye(c.clientX),N(c.clientY));return}}),window.addEventListener("mouseup",()=>{Ae(!1)}),window.addEventListener("mousemove",c=>{const b=Me();if(b||(me(c.clientX),he(c.clientY),le(!0)),b){const p=Se(),o=Le(),t=c.clientX-p,L=c.clientY-o;ye(c.clientX),N(c.clientY);const B=.005;te.theta+=t*B,te.phi-=L*B,te.clamp()}},{passive:!0}),e.addEventListener("wheel",c=>{c.preventDefault();const b=Math.pow(1.1,c.deltaY*.01);te.radius*=b,te.clamp()},{passive:!1});function Z(){const c=document.getElementById("animationList");if(!c)return;if(c.innerHTML="",a.animSystem.animations.size===0&&a.animSystem.emitters.size===0&&a.animSystem.groups.size===0){const p=document.createElement("p");p.style.color="#888",p.style.fontSize="12px",p.style.margin="8px 0",p.textContent="No animations, emitters, or groups defined",c.appendChild(p);return}if(a.animSystem.animations.size>0){const p=document.createElement("h5");p.textContent="Animations",p.style.margin="8px 0 4px 0",c.appendChild(p)}for(const[p,o]of a.animSystem.animations.entries()){const t=document.createElement("div");t.className="animation-item expanded";const L=document.createElement("div");L.className="animation-header";const B=document.createElement("div");B.className="animation-header-left";const H=document.createElement("span");if(H.className="animation-name",H.textContent=p,B.appendChild(H),o.loop){const r=document.createElement("span");r.className="animation-badge",r.textContent="loop",B.appendChild(r)}const K=document.createElement("div");K.className="animation-header-right";const V=document.createElement("div");V.className="animation-controls-inline";const Q=document.createElement("button");Q.textContent="▶",Q.title="Play",Q.className="animation-btn",Q.addEventListener("click",()=>{a.animSystem.playAnimation(p)});const D=document.createElement("button");D.textContent="⏹",D.title="Stop",D.className="animation-btn",D.addEventListener("click",()=>{a.animSystem.stopAnimation(p)});const z=document.createElement("button");z.textContent="↺",z.title="Reset",z.className="animation-btn",z.addEventListener("click",()=>{a.animSystem.resetAnimation(p)});const O=document.createElement("button");O.textContent="⎘",O.title="Duplicate animation",O.className="animation-btn keyframe-duplicate-btn",O.addEventListener("click",()=>{const r=a.animSystem.generateUniqueAnimationName(p),d=a.animSystem.addAnimation(r,o.regionName);d.loop=o.loop,d.keyframes=JSON.parse(JSON.stringify(o.keyframes)),Z()});const P=document.createElement("button");P.textContent="×",P.title="Delete animation",P.className="animation-btn delete-animation-btn",P.addEventListener("click",()=>{confirm(`Delete animation "${p}"?`)&&(a.animSystem.removeAnimation(p),Z())}),V.appendChild(Q),V.appendChild(D),V.appendChild(z),V.appendChild(O),V.appendChild(P),K.appendChild(V),L.appendChild(B),L.appendChild(K);const U=document.createElement("div");U.className="animation-form";const G=document.createElement("div");G.className="form-row";const _=document.createElement("label");_.textContent="Region:",_.className="form-label";const Y=document.createElement("select");Y.className="form-select";const ee=document.createElement("option");ee.value="",ee.textContent="(none)",Y.appendChild(ee);for(const[r,d]of a.animSystem.regions.entries()){const n=document.createElement("option");n.value=r,n.textContent=r,n.selected=o.regionName===r,Y.appendChild(n)}Y.addEventListener("change",r=>{const d=r.target.value||null;o.regionName=d,d&&a.animSystem.regions.has(d)?o.region=a.animSystem.regions.get(d):o.region=null}),G.appendChild(_),G.appendChild(Y);const X=document.createElement("div");X.className="form-row";const $=document.createElement("input");$.type="checkbox",$.id=`anim-loop-${p}`,$.checked=o.loop,$.addEventListener("change",r=>{o.loop=r.target.checked,Z()});const J=document.createElement("label");J.htmlFor=`anim-loop-${p}`,J.textContent="Loop",J.className="form-checkbox-label",X.appendChild($),X.appendChild(J),U.appendChild(G),U.appendChild(X);const u=document.createElement("div");u.className="keyframes-section";const g=document.createElement("div");g.className="keyframes-header";const x=document.createElement("h6");x.textContent="Keyframes",x.style.margin="0",x.style.fontSize="12px",x.style.color="#888",x.style.fontWeight="600",x.style.textTransform="uppercase";const S=document.createElement("button");S.textContent="+ Add",S.className="add-keyframe-btn",S.addEventListener("click",()=>{o.keyframes.push({type:"wait",duration:1}),Z()}),g.appendChild(x),g.appendChild(S),u.appendChild(g);const I=document.createElement("div");I.className="keyframes-list",o.keyframes.forEach((r,d)=>{const n=document.createElement("div");n.className="keyframe-item";const m=document.createElement("div");m.className="keyframe-header";const E=document.createElement("span");E.className="keyframe-type-label",E.textContent=`${d+1}. ${r.type.toUpperCase()}`;const f=document.createElement("div");if(f.className="keyframe-buttons",d>0){const v=document.createElement("button");v.textContent="↑",v.className="keyframe-move-btn",v.title="Move keyframe up",v.addEventListener("click",()=>{[o.keyframes[d-1],o.keyframes[d]]=[o.keyframes[d],o.keyframes[d-1]],Z()}),f.appendChild(v)}if(d<o.keyframes.length-1){const v=document.createElement("button");v.textContent="↓",v.className="keyframe-move-btn",v.title="Move keyframe down",v.addEventListener("click",()=>{[o.keyframes[d],o.keyframes[d+1]]=[o.keyframes[d+1],o.keyframes[d]],Z()}),f.appendChild(v)}const s=document.createElement("button");s.textContent="⎘",s.className="keyframe-duplicate-btn",s.title="Duplicate keyframe",s.addEventListener("click",()=>{const v=JSON.parse(JSON.stringify(r));o.keyframes.splice(d+1,0,v),Z()});const i=document.createElement("button");i.textContent="×",i.className="keyframe-delete-btn",i.title="Delete keyframe",i.addEventListener("click",()=>{o.keyframes.splice(d,1),Z()}),f.appendChild(s),f.appendChild(i),m.appendChild(E),m.appendChild(f);const l=document.createElement("div");l.className="keyframe-form";const h=document.createElement("div");h.className="form-row";const R=document.createElement("label");R.textContent="Type:",R.className="form-label";const w=document.createElement("select");w.className="form-select",["wait","rotate","move"].forEach(v=>{const k=document.createElement("option");k.value=v,k.textContent=v,k.selected=r.type===v,w.appendChild(k)}),w.addEventListener("change",v=>{r.type;const k=v.target.value;k==="wait"?o.keyframes[d]={type:"wait",duration:r.duration||1}:k==="rotate"?o.keyframes[d]={type:"rotate",from:0,to:90,duration:r.duration||1,pivot:[0,0,0],axis:[0,1,0]}:k==="move"&&(o.keyframes[d]={type:"move",axis:"y",delta:1,duration:r.duration||1}),Z()}),h.appendChild(R),h.appendChild(w),l.appendChild(h);const F=document.createElement("div");F.className="form-row";const C=document.createElement("label");C.textContent="Duration:",C.className="form-label";const ne=document.createElement("input");if(ne.type="number",ne.className="form-input",ne.min="0",ne.step="0.1",ne.value=r.duration||0,ne.addEventListener("change",v=>{r.duration=parseFloat(v.target.value)||0}),F.appendChild(C),F.appendChild(ne),l.appendChild(F),r.type==="rotate"){const v=document.createElement("div");v.className="form-row";const k=document.createElement("label");k.textContent="From:",k.className="form-label";const y=document.createElement("input");y.type="number",y.className="form-input",y.step="1",y.value=r.from||0,y.addEventListener("change",Ce=>{r.from=parseFloat(Ce.target.value)||0}),v.appendChild(k),v.appendChild(y),l.appendChild(v);const A=document.createElement("div");A.className="form-row";const T=document.createElement("label");T.textContent="To:",T.className="form-label";const W=document.createElement("input");W.type="number",W.className="form-input",W.step="1",W.value=r.to||0,W.addEventListener("change",Ce=>{r.to=parseFloat(Ce.target.value)||0}),A.appendChild(T),A.appendChild(W),l.appendChild(A);const j=document.createElement("div");j.className="form-row";const ce=document.createElement("label");ce.textContent="Pivot:",ce.className="form-label";const Ne=document.createElement("input");Ne.type="text",Ne.className="form-input",Ne.placeholder="0, 0, 0",Ne.value=r.pivot?r.pivot.join(", "):"0, 0, 0",Ne.addEventListener("change",Ce=>{const ve=Ce.target.value.split(",").map(Ue=>parseFloat(Ue.trim())||0);r.pivot=[ve[0]||0,ve[1]||0,ve[2]||0]}),j.appendChild(ce),j.appendChild(Ne),l.appendChild(j);const ke=document.createElement("div");ke.className="form-row";const Pe=document.createElement("label");Pe.textContent="Axis:",Pe.className="form-label";const xe=document.createElement("input");xe.type="text",xe.className="form-input",xe.placeholder="0, 1, 0",xe.value=r.axis?r.axis.join(", "):"0, 1, 0",xe.addEventListener("change",Ce=>{const ve=Ce.target.value.split(",").map(Ue=>parseFloat(Ue.trim())||0);r.axis=[ve[0]||0,ve[1]||0,ve[2]||0]}),ke.appendChild(Pe),ke.appendChild(xe),l.appendChild(ke)}else if(r.type==="move"){const v=document.createElement("div");v.className="form-row";const k=document.createElement("label");k.textContent="Axis:",k.className="form-label";const y=document.createElement("select");y.className="form-select",["x","y","z"].forEach(j=>{const ce=document.createElement("option");ce.value=j,ce.textContent=j.toUpperCase(),ce.selected=r.axis===j,y.appendChild(ce)}),y.addEventListener("change",j=>{r.axis=j.target.value}),v.appendChild(k),v.appendChild(y),l.appendChild(v);const A=document.createElement("div");A.className="form-row";const T=document.createElement("label");T.textContent="Delta:",T.className="form-label";const W=document.createElement("input");W.type="number",W.className="form-input",W.step="0.1",W.value=r.delta||0,W.addEventListener("change",j=>{r.delta=parseFloat(j.target.value)||0}),A.appendChild(T),A.appendChild(W),l.appendChild(A)}if(r.type==="rotate"||r.type==="move"){const v=document.createElement("div");v.className="form-row";const k=document.createElement("label");k.textContent="Easing:",k.className="form-label";const y=document.createElement("select");if(y.className="form-select",["(none)","linear","ease-in","ease-out","ease-in-out","steps"].forEach(T=>{const W=document.createElement("option");W.value=T==="(none)"?"":T,W.textContent=T,W.selected=(r.easing||"")===(T==="(none)"?"":T),y.appendChild(W)}),y.addEventListener("change",T=>{T.target.value?r.easing=T.target.value:delete r.easing,Z()}),v.appendChild(k),v.appendChild(y),l.appendChild(v),r.easing==="steps"){const T=document.createElement("div");T.className="form-row";const W=document.createElement("label");W.textContent="Steps:",W.className="form-label";const j=document.createElement("input");j.type="number",j.className="form-input",j.min="1",j.step="1",j.value=r.steps||10,j.addEventListener("change",ce=>{r.steps=parseInt(ce.target.value)||10}),T.appendChild(W),T.appendChild(j),l.appendChild(T)}}n.appendChild(m),n.appendChild(l),I.appendChild(n)}),u.appendChild(I),U.appendChild(u),t.appendChild(L),t.appendChild(U),c.appendChild(t)}const b=document.createElement("button");b.textContent="+ Add Animation",b.className="add-animation-btn",b.addEventListener("click",()=>{const p=a.animSystem.generateUniqueAnimationName("anim");a.animSystem.addAnimation(p,null),Z()}),c.appendChild(b)}function Ee(){const c=document.getElementById("emitterList");if(!c)return;c.innerHTML="";const b=document.createElement("button");if(b.textContent="+ Add Emitter",b.className="add-animation-btn",b.addEventListener("click",()=>{const o=a.animSystem.generateUniqueEmitterName("emitter");a.animSystem.addEmitter(o),Ee()}),c.appendChild(b),a.animSystem.emitters.size===0){const o=document.createElement("p");o.style.color="#888",o.style.fontSize="12px",o.style.margin="8px 0",o.textContent="No emitters defined",c.appendChild(o);return}const p=document.createElement("h5");p.textContent="Emitters",p.style.margin="8px 0 4px 0",c.appendChild(p);for(const[o,t]of a.animSystem.emitters.entries()){const L=document.createElement("div");L.className="animation-item expanded";const B=document.createElement("div");B.className="animation-header";const H=document.createElement("div");H.className="animation-header-left";const K=document.createElement("span");K.className="animation-name",K.textContent=o,H.appendChild(K);const V=document.createElement("span");if(V.className="animation-badge",V.textContent=`${t.particles.length} particles`,H.appendChild(V),t.enabled){const y=document.createElement("span");y.className="animation-badge",y.textContent="active",y.style.background="rgba(100, 200, 100, 0.3)",H.appendChild(y)}const Q=document.createElement("div");Q.className="animation-header-right";const D=document.createElement("div");D.className="animation-controls-inline";const z=document.createElement("button");z.textContent="▶",z.title="Start",z.className="animation-btn",z.addEventListener("click",()=>{a.animSystem.startEmitter(o),Ee()});const O=document.createElement("button");O.textContent="⏹",O.title="Stop",O.className="animation-btn",O.addEventListener("click",()=>{a.animSystem.stopEmitter(o),Ee()});const P=document.createElement("button");P.textContent="↺",P.title="Clear particles",P.className="animation-btn",P.addEventListener("click",()=>{a.animSystem.clearEmitter(o)});const U=document.createElement("button");U.textContent="⎘",U.title="Duplicate emitter",U.className="animation-btn keyframe-duplicate-btn",U.addEventListener("click",()=>{const y=a.animSystem.generateUniqueEmitterName(o),A=a.animSystem.addEmitter(y);A.position=[...t.position],A.rate=t.rate,A.particleLifetime=t.particleLifetime,A.particleSize=t.particleSize,A.velocityBase=[...t.velocityBase],A.velocitySpread=[...t.velocitySpread],A.colorIds=[...t.colorIds],A.gravity=[...t.gravity],A.maxParticles=t.maxParticles,Ee()});const G=document.createElement("button");G.textContent="×",G.title="Delete emitter",G.className="animation-btn delete-animation-btn",G.addEventListener("click",()=>{confirm(`Delete emitter "${o}"?`)&&(a.animSystem.removeEmitter(o),Ee())}),D.appendChild(z),D.appendChild(O),D.appendChild(P),D.appendChild(U),D.appendChild(G),Q.appendChild(D),B.appendChild(H),B.appendChild(Q);const _=document.createElement("div");_.className="animation-form";const Y=document.createElement("div");Y.className="form-row";const ee=document.createElement("label");ee.textContent="Position:",ee.className="form-label";const X=document.createElement("input");X.type="text",X.className="form-input",X.placeholder="0, 0, 0",X.value=t.position.join(", "),X.addEventListener("change",y=>{const A=y.target.value.split(",").map(T=>parseFloat(T.trim())||0);t.position=[A[0]||0,A[1]||0,A[2]||0]}),Y.appendChild(ee),Y.appendChild(X),_.appendChild(Y);const $=document.createElement("div");$.className="form-row";const J=document.createElement("label");J.textContent="Rate:",J.className="form-label";const u=document.createElement("input");u.type="number",u.className="form-input",u.min="0",u.step="1",u.value=t.rate,u.title="Particles per second",u.addEventListener("change",y=>{t.rate=parseFloat(y.target.value)||10}),$.appendChild(J),$.appendChild(u),_.appendChild($);const g=document.createElement("div");g.className="form-row";const x=document.createElement("label");x.textContent="Lifetime:",x.className="form-label";const S=document.createElement("input");S.type="number",S.className="form-input",S.min="0",S.step="0.1",S.value=t.particleLifetime,S.title="How long each particle lives (seconds)",S.addEventListener("change",y=>{t.particleLifetime=parseFloat(y.target.value)||2}),g.appendChild(x),g.appendChild(S),_.appendChild(g);const I=document.createElement("div");I.className="form-row";const r=document.createElement("label");r.textContent="Size:",r.className="form-label";const d=document.createElement("input");d.type="number",d.className="form-input",d.min="0",d.step="0.1",d.value=t.particleSize,d.title="Size of each particle cube",d.addEventListener("change",y=>{t.particleSize=parseFloat(y.target.value)||.2}),I.appendChild(r),I.appendChild(d),_.appendChild(I);const n=document.createElement("div");n.className="form-row";const m=document.createElement("label");m.textContent="Velocity:",m.className="form-label";const E=document.createElement("input");E.type="text",E.className="form-input",E.placeholder="0, 5, 0",E.value=t.velocityBase.join(", "),E.title="Base velocity vector",E.addEventListener("change",y=>{const A=y.target.value.split(",").map(T=>parseFloat(T.trim())||0);t.velocityBase=[A[0]||0,A[1]||0,A[2]||0]}),n.appendChild(m),n.appendChild(E),_.appendChild(n);const f=document.createElement("div");f.className="form-row";const s=document.createElement("label");s.textContent="Spread:",s.className="form-label";const i=document.createElement("input");i.type="text",i.className="form-input",i.placeholder="1, 1, 1",i.value=t.velocitySpread.join(", "),i.title="Random velocity spread amount",i.addEventListener("change",y=>{const A=y.target.value.split(",").map(T=>parseFloat(T.trim())||0);t.velocitySpread=[A[0]||0,A[1]||0,A[2]||0]}),f.appendChild(s),f.appendChild(i),_.appendChild(f);const l=document.createElement("div");l.className="form-row";const h=document.createElement("label");h.textContent="Colors:",h.className="form-label";const R=document.createElement("input");R.type="text",R.className="form-input",R.placeholder="0, 1, 2",R.value=t.colorIds.join(", "),R.title="Material IDs to randomly use (0-15)",R.addEventListener("change",y=>{const A=y.target.value.split(",").map(T=>Math.floor(parseFloat(T.trim()))||0);t.colorIds=A.filter(T=>T>=0&&T<=15),t.colorIds.length===0&&(t.colorIds=[0])}),l.appendChild(h),l.appendChild(R),_.appendChild(l);const w=document.createElement("div");w.className="form-row";const F=document.createElement("label");F.textContent="Gravity:",F.className="form-label";const C=document.createElement("input");C.type="text",C.className="form-input",C.placeholder="0, -9.8, 0",C.value=t.gravity.join(", "),C.title="Gravity acceleration vector",C.addEventListener("change",y=>{const A=y.target.value.split(",").map(T=>parseFloat(T.trim())||0);t.gravity=[A[0]||0,A[1]||0,A[2]||0]}),w.appendChild(F),w.appendChild(C),_.appendChild(w);const ne=document.createElement("div");ne.className="form-row";const v=document.createElement("label");v.textContent="Max Particles:",v.className="form-label";const k=document.createElement("input");k.type="number",k.className="form-input",k.min="1",k.step="1",k.value=t.maxParticles,k.title="Maximum number of particles (safety limit)",k.addEventListener("change",y=>{t.maxParticles=parseInt(y.target.value)||1e3}),ne.appendChild(v),ne.appendChild(k),_.appendChild(ne),L.appendChild(B),L.appendChild(_),c.appendChild(L)}}function ae(){const c=document.getElementById("groupList");if(!c)return;c.innerHTML="";const b=document.createElement("button");if(b.textContent="+ Add Group",b.className="add-animation-btn",b.addEventListener("click",()=>{const o=a.animSystem.generateUniqueGroupName("group");a.animSystem.addGroup(o),ae()}),c.appendChild(b),a.animSystem.groups.size===0){const o=document.createElement("p");o.style.color="#888",o.style.fontSize="12px",o.style.margin="8px 0",o.textContent="No groups defined",c.appendChild(o);return}const p=document.createElement("h5");p.textContent="Groups",p.style.margin="8px 0 4px 0",c.appendChild(p);for(const[o,t]of a.animSystem.groups.entries()){const L=document.createElement("div");L.className="animation-item expanded";const B=document.createElement("div");B.className="animation-header";const H=document.createElement("div");H.className="animation-header-left";const K=document.createElement("span");K.className="animation-name",K.textContent=o,H.appendChild(K);const V=document.createElement("span");V.className="animation-badge";const Q=t.animationNames.length+t.emitterNames.length;V.textContent=`${Q} items`,H.appendChild(V);const D=document.createElement("div");D.className="animation-header-right";const z=document.createElement("div");z.className="animation-controls-inline";const O=document.createElement("button");O.textContent="▶",O.title="Play group",O.className="animation-btn",O.addEventListener("click",()=>{a.animSystem.playGroup(o)});const P=document.createElement("button");P.textContent="⏹",P.title="Stop group",P.className="animation-btn",P.addEventListener("click",()=>{a.animSystem.stopGroup(o)});const U=document.createElement("button");U.textContent="↺",U.title="Reset group",U.className="animation-btn",U.addEventListener("click",()=>{a.animSystem.resetGroup(o)});const G=document.createElement("button");G.textContent="⎘",G.title="Duplicate group",G.className="animation-btn keyframe-duplicate-btn",G.addEventListener("click",()=>{const i=a.animSystem.generateUniqueGroupName(o),l=a.animSystem.addGroup(i);l.animationNames=[...t.animationNames],l.emitterNames=[...t.emitterNames],ae()});const _=document.createElement("button");_.textContent="×",_.title="Delete group",_.className="animation-btn delete-animation-btn",_.addEventListener("click",()=>{confirm(`Delete group "${o}"?`)&&(a.animSystem.removeGroup(o),ae())}),z.appendChild(O),z.appendChild(P),z.appendChild(U),z.appendChild(G),z.appendChild(_),D.appendChild(z),B.appendChild(H),B.appendChild(D);const Y=document.createElement("div");Y.className="animation-form";const ee=document.createElement("div");ee.className="form-row";const X=document.createElement("label");X.textContent="Guard State:",X.className="form-label";const $=document.createElement("input");$.type="text",$.className="form-input",$.placeholder="(none)",$.value=t.guard||"",$.addEventListener("change",i=>{t.guard=i.target.value||null}),ee.appendChild(X),ee.appendChild($),Y.appendChild(ee);const J=document.createElement("div");J.className="form-row";const u=document.createElement("label");u.textContent="End State:",u.className="form-label";const g=document.createElement("input");g.type="text",g.className="form-input",g.placeholder="(none)",g.value=t.endState||"",g.addEventListener("change",i=>{t.endState=i.target.value||null}),J.appendChild(u),J.appendChild(g),Y.appendChild(J);const x=document.createElement("div");x.className="group-section";const S=document.createElement("div");S.className="group-section-header";const I=document.createElement("h6");I.textContent="Animations",I.style.margin="0",I.style.fontSize="12px",I.style.color="#888",I.style.fontWeight="600",I.style.textTransform="uppercase";const r=document.createElement("button");r.textContent="+",r.className="group-add-btn",r.title="Add animation to group",r.addEventListener("click",()=>{const i=Array.from(a.animSystem.animations.keys()).filter(l=>!t.animationNames.includes(l));if(i.length===0){alert("No animations available to add");return}t.addAnimation(i[0]),ae()}),S.appendChild(I),S.appendChild(r),x.appendChild(S);const d=document.createElement("div");if(d.className="group-item-list",t.animationNames.length===0){const i=document.createElement("p");i.style.color="#666",i.style.fontSize="11px",i.style.margin="4px 0",i.style.fontStyle="italic",i.textContent="No animations",d.appendChild(i)}else t.animationNames.forEach((i,l)=>{const h=document.createElement("div");h.className="group-item";const R=document.createElement("span");R.textContent=i,R.style.fontSize="12px",R.style.color="#cfd3dc";const w=document.createElement("div");if(w.className="group-item-buttons",l>0){const C=document.createElement("button");C.textContent="↑",C.className="keyframe-move-btn",C.title="Move up",C.addEventListener("click",()=>{[t.animationNames[l-1],t.animationNames[l]]=[t.animationNames[l],t.animationNames[l-1]],ae()}),w.appendChild(C)}if(l<t.animationNames.length-1){const C=document.createElement("button");C.textContent="↓",C.className="keyframe-move-btn",C.title="Move down",C.addEventListener("click",()=>{[t.animationNames[l],t.animationNames[l+1]]=[t.animationNames[l+1],t.animationNames[l]],ae()}),w.appendChild(C)}const F=document.createElement("button");F.textContent="×",F.className="group-remove-btn",F.title="Remove from group",F.addEventListener("click",()=>{t.animationNames.splice(l,1),ae()}),w.appendChild(F),h.appendChild(R),h.appendChild(w),d.appendChild(h)});x.appendChild(d),Y.appendChild(x);const n=document.createElement("div");n.className="group-section";const m=document.createElement("div");m.className="group-section-header";const E=document.createElement("h6");E.textContent="Emitters",E.style.margin="0",E.style.fontSize="12px",E.style.color="#888",E.style.fontWeight="600",E.style.textTransform="uppercase";const f=document.createElement("button");f.textContent="+",f.className="group-add-btn",f.title="Add emitter to group",f.addEventListener("click",()=>{const i=Array.from(a.animSystem.emitters.keys()).filter(l=>!t.emitterNames.includes(l));if(i.length===0){alert("No emitters available to add");return}t.addEmitter(i[0]),ae()}),m.appendChild(E),m.appendChild(f),n.appendChild(m);const s=document.createElement("div");if(s.className="group-item-list",t.emitterNames.length===0){const i=document.createElement("p");i.style.color="#666",i.style.fontSize="11px",i.style.margin="4px 0",i.style.fontStyle="italic",i.textContent="No emitters",s.appendChild(i)}else t.emitterNames.forEach((i,l)=>{const h=document.createElement("div");h.className="group-item";const R=document.createElement("span");R.textContent=i,R.style.fontSize="12px",R.style.color="#cfd3dc";const w=document.createElement("div");if(w.className="group-item-buttons",l>0){const C=document.createElement("button");C.textContent="↑",C.className="keyframe-move-btn",C.title="Move up",C.addEventListener("click",()=>{[t.emitterNames[l-1],t.emitterNames[l]]=[t.emitterNames[l],t.emitterNames[l-1]],ae()}),w.appendChild(C)}if(l<t.emitterNames.length-1){const C=document.createElement("button");C.textContent="↓",C.className="keyframe-move-btn",C.title="Move down",C.addEventListener("click",()=>{[t.emitterNames[l],t.emitterNames[l+1]]=[t.emitterNames[l+1],t.emitterNames[l]],ae()}),w.appendChild(C)}const F=document.createElement("button");F.textContent="×",F.className="group-remove-btn",F.title="Remove from group",F.addEventListener("click",()=>{t.emitterNames.splice(l,1),ae()}),w.appendChild(F),h.appendChild(R),h.appendChild(w),s.appendChild(h)});n.appendChild(s),Y.appendChild(n),L.appendChild(B),L.appendChild(Y),c.appendChild(L)}}function ie(){const c=document.getElementById("regionList");if(!c)return;if(c.innerHTML="",a.animSystem.regions.size===0){const t=document.createElement("p");t.style.color="#888",t.style.fontSize="12px",t.style.margin="8px 0",t.textContent="No regions defined",c.appendChild(t);return}if(a.animSystem.regions.size>0){const t=document.createElement("h5");t.textContent="Regions",t.style.margin="8px 0 4px 0",c.appendChild(t)}const b=a.getRegionOverlaysVisible(),p=a.getSelectedRegionName();for(const[t,L]of a.animSystem.regions.entries()){const B=document.createElement("div");B.className="region-item",p===t&&B.classList.add("selected");const H=document.createElement("div");H.className="region-header";const K=document.createElement("input");K.type="text",K.className="region-name-input",K.value=t,K.addEventListener("change",u=>{const g=u.target.value.trim();if(!g){alert("Region name cannot be empty"),u.target.value=t;return}if(g!==t)try{const x=b.get(t)||!1;a.animSystem.renameRegion(t,g),b.delete(t),x&&b.set(g,x),p===t&&a.setSelectedRegionName(g),a.chunk.clearRegions(),a.animSystem.regions.forEach((S,I)=>{a.chunk.addRegion(I,S.min,S.max)}),a.animSystem.assignVoxelsToRegions(a.chunk),a.buildAllMeshes(),ie(),Z()}catch(x){alert(x.message),u.target.value=t}});const V=document.createElement("div");V.className="region-header-controls";const Q=document.createElement("div");Q.className="region-toggle";const D=document.createElement("input");D.type="checkbox",D.id=`region-vis-${t}`,D.checked=b.get(t)||!1,D.addEventListener("change",u=>{b.set(t,u.target.checked),u.target.checked&&(a.setSelectedRegionName(t),ie())});const z=document.createElement("label");z.htmlFor=`region-vis-${t}`,z.textContent="Show",Q.appendChild(D),Q.appendChild(z);const O=document.createElement("button");O.textContent="⎘",O.className="duplicate-region-btn",O.title="Duplicate region",O.addEventListener("click",()=>{const u=a.animSystem.generateUniqueRegionName(t);a.animSystem.addRegion(u,[...L.min],[...L.max]),a.chunk.clearRegions(),a.animSystem.regions.forEach((g,x)=>{a.chunk.addRegion(x,g.min,g.max)}),a.animSystem.assignVoxelsToRegions(a.chunk),a.buildAllMeshes(),ie()});const P=document.createElement("button");P.textContent="×",P.className="delete-region-btn",P.title="Delete region",P.addEventListener("click",()=>{confirm(`Delete region "${t}"? This will also remove any animations using this region.`)&&(a.animSystem.removeRegion(t),b.delete(t),p===t&&a.setSelectedRegionName(null),a.chunk.clearRegions(),a.animSystem.regions.forEach((u,g)=>{a.chunk.addRegion(g,u.min,u.max)}),a.animSystem.assignVoxelsToRegions(a.chunk),a.buildAllMeshes(),ie(),Z())}),V.appendChild(Q),V.appendChild(O),V.appendChild(P),H.appendChild(K),H.appendChild(V);const U=document.createElement("div");U.className="region-bounds";const G=()=>{a.chunk.clearRegions(),a.animSystem.regions.forEach((u,g)=>{a.chunk.addRegion(g,u.min,u.max)}),a.animSystem.assignVoxelsToRegions(a.chunk),a.buildAllMeshes()},_=document.createElement("div");_.className="form-row";const Y=document.createElement("label");Y.className="form-label",Y.textContent="Min:",_.appendChild(Y);const ee=document.createElement("div");ee.style.display="flex",ee.style.gap="8px",["x","y","z"].forEach((u,g)=>{const x=document.createElement("div");x.className="shift-button-group";const S=document.createElement("button");S.className="shift-btn shift-minus",S.textContent="−",S.title=`Decrease min ${u.toUpperCase()}`,S.addEventListener("click",()=>{L.min[g]>0&&(L.min[g]--,G(),ie())});const I=document.createElement("span");I.className=`shift-label shift-${u}`;const r=document.createElement("span");r.className="shift-value",r.textContent=L.min[g],I.appendChild(r);const d=document.createElement("button");d.className="shift-btn shift-plus",d.textContent="+",d.title=`Increase min ${u.toUpperCase()}`,d.addEventListener("click",()=>{L.min[g]<255&&(L.min[g]++,G(),ie())}),x.appendChild(S),x.appendChild(I),x.appendChild(d),ee.appendChild(x)}),_.appendChild(ee),U.appendChild(_);const X=document.createElement("div");X.className="form-row";const $=document.createElement("label");$.className="form-label",$.textContent="Max:",X.appendChild($);const J=document.createElement("div");J.style.display="flex",J.style.gap="8px",["x","y","z"].forEach((u,g)=>{const x=document.createElement("div");x.className="shift-button-group";const S=document.createElement("button");S.className="shift-btn shift-minus",S.textContent="−",S.title=`Decrease max ${u.toUpperCase()}`,S.addEventListener("click",()=>{L.max[g]>0&&(L.max[g]--,G(),ie())});const I=document.createElement("span");I.className=`shift-label shift-${u}`;const r=document.createElement("span");r.className="shift-value",r.textContent=L.max[g],I.appendChild(r);const d=document.createElement("button");d.className="shift-btn shift-plus",d.textContent="+",d.title=`Increase max ${u.toUpperCase()}`,d.addEventListener("click",()=>{L.max[g]<255&&(L.max[g]++,G(),ie())}),x.appendChild(S),x.appendChild(I),x.appendChild(d),J.appendChild(x)}),X.appendChild(J),U.appendChild(X),B.appendChild(H),B.appendChild(U),c.appendChild(B)}const o=document.createElement("button");o.textContent="+ Add Region",o.className="add-region-btn",o.addEventListener("click",()=>{const t=a.animSystem.generateUniqueRegionName("region");a.animSystem.addRegion(t,[0,0,0],[1,1,1]),a.chunk.clearRegions(),a.animSystem.regions.forEach((L,B)=>{a.chunk.addRegion(B,L.min,L.max)}),a.animSystem.assignVoxelsToRegions(a.chunk),a.buildAllMeshes(),ie(),Z()}),c.appendChild(o)}document.getElementById("btnPlay")?.addEventListener("click",()=>{for(const[c,b]of a.animSystem.animations.entries())b.loop&&a.animSystem.playAnimation(c);for(const[c,b]of a.animSystem.emitters.entries())a.animSystem.startEmitter(c)}),document.getElementById("btnPause")?.addEventListener("click",()=>{for(const c of a.animSystem.animations.values())c.stop();for(const c of a.animSystem.emitters.values())c.stop()}),document.getElementById("btnResetAll")?.addEventListener("click",()=>{a.animSystem.resetAll()})}function it(){const a=document.getElementById("gl"),e=a.getContext("webgl2",{antialias:!0,alpha:!1});if(!e){alert("WebGL2 not supported");return}e.enable(e.DEPTH_TEST),e.enable(e.CULL_FACE),e.cullFace(e.BACK);const M=we(e,Oe,ze);M.meta.visible=!0,M.meta.regions={};const re=we(e,Ge,Ve),oe=we(e,He,Xe),te=we(e,$e,Ye),q=we(e,qe,We),Fe=Je();e.bindVertexArray(oe.vao),e.bindBuffer(e.ARRAY_BUFFER,e.createBuffer()),e.bufferData(e.ARRAY_BUFFER,Fe.positions,e.STATIC_DRAW),e.enableVertexAttribArray(oe.aPosition.location),e.vertexAttribPointer(oe.aPosition.location,3,e.FLOAT,!1,0,0),e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,e.createBuffer()),e.bufferData(e.ELEMENT_ARRAY_BUFFER,Fe.indices,e.STATIC_DRAW),e.bindVertexArray(null);function Re(){const n=et(N.sizeX,N.sizeZ);e.bindVertexArray(te.vao),e.bindBuffer(e.ARRAY_BUFFER,e.createBuffer()),e.bufferData(e.ARRAY_BUFFER,n.positions,e.STATIC_DRAW),e.enableVertexAttribArray(te.aPosition.location),e.vertexAttribPointer(te.aPosition.location,3,e.FLOAT,!1,0,0),e.bindBuffer(e.ARRAY_BUFFER,e.createBuffer()),e.bufferData(e.ARRAY_BUFFER,n.colors,e.STATIC_DRAW),e.enableVertexAttribArray(te.aColor.location),e.vertexAttribPointer(te.aColor.location,3,e.FLOAT,!1,0,0),e.bindVertexArray(null),te.meta.count=n.count}const fe=je();if(e.bindVertexArray(q.vao),q.aPosition&&(e.bindBuffer(e.ARRAY_BUFFER,e.createBuffer()),e.bufferData(e.ARRAY_BUFFER,fe.positions,e.STATIC_DRAW),e.enableVertexAttribArray(q.aPosition.location),e.vertexAttribPointer(q.aPosition.location,3,e.FLOAT,!1,0,0)),q.aNormal&&(e.bindBuffer(e.ARRAY_BUFFER,e.createBuffer()),e.bufferData(e.ARRAY_BUFFER,fe.normals,e.STATIC_DRAW),e.enableVertexAttribArray(q.aNormal.location),e.vertexAttribPointer(q.aNormal.location,3,e.FLOAT,!1,0,0)),q.aMatId){const n=new Uint8Array(fe.positions.length/3);e.bindBuffer(e.ARRAY_BUFFER,e.createBuffer()),e.bufferData(e.ARRAY_BUFFER,n,e.STATIC_DRAW),e.enableVertexAttribArray(q.aMatId.location),e.vertexAttribIPointer(q.aMatId.location,1,e.UNSIGNED_BYTE,0,0)}e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,e.createBuffer()),e.bufferData(e.ELEMENT_ARRAY_BUFFER,fe.indices,e.STATIC_DRAW),e.bindVertexArray(null);const le=new tt;let Me=new Map,Ae=0,Se=null,ye=new Map,Le=16;const N=new Ze(Le);N.seedMaterials("bands"),Re();const me=new Ke({target:[8,8,8],radius:40,theta:De(215),phi:De(60)}),he=_e.identity();let de=_e.perspective(60*Math.PI/180,1,.01,100);const Be=.22;let Te=1,se=null,pe=null,ue=null,ge=0,be=0;function Ie(){const n=a.width,m=a.height;n===ge&&m===be&&se||(pe&&e.deleteTexture(pe),ue&&e.deleteRenderbuffer(ue),se&&e.deleteFramebuffer(se),pe=e.createTexture(),e.bindTexture(e.TEXTURE_2D,pe),e.texImage2D(e.TEXTURE_2D,0,e.RGBA8,n,m,0,e.RGBA,e.UNSIGNED_BYTE,null),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),ue=e.createRenderbuffer(),e.bindRenderbuffer(e.RENDERBUFFER,ue),e.renderbufferStorage(e.RENDERBUFFER,e.DEPTH_COMPONENT16,n,m),se=e.createFramebuffer(),e.bindFramebuffer(e.FRAMEBUFFER,se),e.framebufferTexture2D(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.TEXTURE_2D,pe,0),e.framebufferRenderbuffer(e.FRAMEBUFFER,e.DEPTH_ATTACHMENT,e.RENDERBUFFER,ue),e.bindFramebuffer(e.FRAMEBUFFER,null),ge=n,be=m)}function Z(){Te=Math.max(1,Math.min(2,window.devicePixelRatio||1));const n=a.clientWidth||a.parentElement.clientWidth,m=a.clientHeight||a.parentElement.clientHeight;a.width=Math.round(n*Te),a.height=Math.round(m*Te),e.viewport(0,0,a.width,a.height),de=_e.perspective(60*Math.PI/180,a.width/a.height,.01,100),Ie()}window.addEventListener("resize",Z,{passive:!0}),requestAnimationFrame(Z);function Ee(){e.bindFramebuffer(e.FRAMEBUFFER,se),e.viewport(0,0,ge,be),e.clearColor(0,0,0,1),e.clear(e.COLOR_BUFFER_BIT|e.DEPTH_BUFFER_BIT);const n=e.isEnabled(e.CULL_FACE);n&&e.disable(e.CULL_FACE),e.useProgram(re.program),re.uModel.set(he),re.uView.set(me.view()),re.uProj.set(de),e.bindVertexArray(re.vao),e.drawElements(e.TRIANGLES,re.meta.pickVoxelCount,e.UNSIGNED_INT,0),e.bindVertexArray(null),n&&e.enable(e.CULL_FACE),e.bindFramebuffer(e.FRAMEBUFFER,null)}function ae(n,m){const E=a.getBoundingClientRect(),f=Math.floor((n-E.left)*(a.width/E.width)),s=Math.floor((E.height-(m-E.top))*(a.height/E.height));return{x:f,y:s}}function ie(n,m){if(re.meta.pickVoxelCount===0&&re.meta.pickGroundCount===0)return{voxel:-1,face:-1};Ee();const{x:E,y:f}=ae(n,m),s=new Uint8Array(4);e.bindFramebuffer(e.FRAMEBUFFER,se),e.readPixels(E,f,1,1,e.RGBA,e.UNSIGNED_BYTE,s),e.bindFramebuffer(e.FRAMEBUFFER,null);const i=s[0]|s[1]<<8|s[2]<<16;if(i===0)return{voxel:-1,face:-1};const l=i&7,h=(i>>4)-1;return h<0||h>=N.length?{voxel:-1,face:-1}:{voxel:h,face:l}}function c(n,m,E,f,s,i,l,h=1.006){const R=f-n+1,w=s-m+1,F=i-E+1,C=n+R*.5,ne=m+w*.5,v=E+F*.5;e.useProgram(oe.program),oe.uModel.set(he),oe.uView.set(me.view()),oe.uProj.set(de),oe.uOffset.set(new Float32Array([C,ne,v])),oe.uScaleVec.set(new Float32Array([R,w,F])),oe.uInflate.set(h),oe.uColor.set(new Float32Array(l)),e.bindVertexArray(oe.vao),e.drawElements(e.LINES,Fe.count,e.UNSIGNED_SHORT,0),e.bindVertexArray(null)}function b(n,m,E=1.006){const[f,s,i]=N.coordsOf(n);c(f,s,i,f,s,i,m,E)}const p=new Qe(null,n=>{},(n,m,E)=>{const f=beginPaletteAction(`Palette ${n}`);recordPaletteChange(f,n,m,E),commitAction(f,!1)});function o(n){return n>=0&&n<=9?String.fromCharCode(48+n):n>=10&&n<=15?String.fromCharCode(97+(n-10)):"0"}function t(n){return Math.max(0,Math.min(255,n)).toString(16).padStart(2,"0")}function L(){const n=[];for(let s=0;s<16;s++)n.push(at(p.colors[s*3+0],p.colors[s*3+1],p.colors[s*3+2]));const m=[],f=Math.max(N.sizeX,N.sizeY,N.sizeZ)<=16;for(let s=0;s<N.sizeZ;s++)for(let i=0;i<N.sizeY;i++)for(let l=0;l<N.sizeX;l++){const h=N.idx3(l,i,s);N.isSolid(h)&&(f?m.push(`${o(l)}${o(i)}${o(s)}${o(N.material(h))}`):m.push(`${t(l)}${t(i)}${t(s)}${o(N.material(h))}`))}return Object.assign({version:1,size:[N.sizeX,N.sizeY,N.sizeZ],palette:n,voxels:m},le.toJSON())}function B(n){const m=n.toLowerCase();return m>="0"&&m<="9"?m.charCodeAt(0)-48:m>="a"&&m<="f"?10+(m.charCodeAt(0)-97):0}function H(n){return parseInt(n,16)||0}function K(n){if(!n||typeof n!="object")throw new Error("Root must be object");if(!Array.isArray(n.voxels))throw new Error('Missing "voxels"');let m,E,f;if(Array.isArray(n.size)){if(n.size.length!==3)throw new Error("Size array must have 3 elements [x, y, z]");[m,E,f]=n.size}else if(typeof n.size=="number")m=E=f=n.size;else throw new Error('Invalid "size" field');if(m===16&&E===16&&f===16?N.resetSize():(N.resetSize(),N.expandSize(m,E,f)),Le=Math.max(m,E,f),me.target=[m/2,E/2,f/2],Re(),Array.isArray(n.palette))for(let s=0;s<Math.min(16,n.palette.length);s++){const i=n.palette[s];let l;typeof i=="string"?l=nt(i):Array.isArray(i)&&i.length>=3&&(l=[+i[0],+i[1],+i[2]]),l&&p.setPaletteColor(s,[Math.max(0,Math.min(1,l[0])),Math.max(0,Math.min(1,l[1])),Math.max(0,Math.min(1,l[2]))])}N.fill(!1),N.setMaterialAll(0);for(const s of n.voxels){if(!s)continue;let i,l,h,R;if(typeof s=="string")if(s.length===4)i=B(s[0]),l=B(s[1]),h=B(s[2]),R=(B(s[3])|0)&15;else if(s.length===7)i=H(s.substring(0,2)),l=H(s.substring(2,4)),h=H(s.substring(4,6)),R=(B(s[6])|0)&15;else continue;else if(Array.isArray(s)&&s.length>=4)[i,l,h,R]=s;else continue;if(N.within(i,l,h)){const w=N.idx3(i,l,h);N.setSolid(w,!0),N.setMaterial(w,R)}}N.clearRegions(),console.log(n),n.regions&&(le.fromJSON(n),le.assignVoxelsToRegions(N),le.regions.forEach((s,i)=>{N.addRegion(i,s.min,s.max)})),X()}let V=!1,Q=0,D=0,z=0,O=0,P=!0,U=-1,G=-1,_=()=>{};function Y(){if(!P)return;P=!1;const n=ie(z,O);U=n.voxel,G=n.face,_()}const ee=[0,0,0];function X(){M.meta.renderIndexCount=N.buildGreedyRenderMeshMain(e,M,M.vao),N.buildPickFaces(e,re),M.meta.regions={};for(const[n,m]of le.regions.entries())M.meta.regions[n]={},M.meta.regions[n].vao=e.createVertexArray(),M.meta.regions[n].visible=!0,M.meta.regions[n].indexCount=N.buildGreedyRenderMeshRegion(e,M,M.meta.regions[n].vao,n)}X();const $=1e3,J=2,u=64,g=Math.ceil($*J/u),x=e.createTexture();e.bindTexture(e.TEXTURE_2D,x),e.texImage2D(e.TEXTURE_2D,0,e.RGBA32F,u,g,0,e.RGBA,e.FLOAT,null),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE);const S=e.getError();S!==e.NO_ERROR&&console.error("Texture creation error:",S);function I(n){const m=new Float32Array(u*g*4);for(let E=0;E<n.length;E++){const f=n[E],s=E*2,i=E*2+1,l=s%u,h=Math.floor(s/u),R=i%u,w=Math.floor(i/u),F=(h*u+l)*4,C=(w*u+R)*4;m[F+0]=f.position[0],m[F+1]=f.position[1],m[F+2]=f.position[2],m[F+3]=f.size,m[C+0]=f.color/255,m[C+1]=f.getAlpha(),m[C+2]=0,m[C+3]=0}e.bindTexture(e.TEXTURE_2D,x),e.texSubImage2D(e.TEXTURE_2D,0,0,0,u,g,e.RGBA,e.FLOAT,m)}function r(){const n=performance.now(),m=(n-Ae)/1e3;Ae=n,le.update(m),e.clearColor(.07,.08,.1,1),e.clear(e.COLOR_BUFFER_BIT|e.DEPTH_BUFFER_BIT),e.useProgram(M.program),M.uPalette.set(p.colors),M.uView.set(me.view()),M.uProj.set(de),M.uNormalMat.set(new Float32Array([1,0,0,0,1,0,0,0,1])),M.uLightDirWS.set(new Float32Array([.7/1.7,-1.2/1.7,.9/1.7])),M.uAmbient.set(Be),M.meta.visible&&(M.uModel.set(he),e.bindVertexArray(M.vao),e.drawElements(e.TRIANGLES,M.meta.renderIndexCount,e.UNSIGNED_INT,0),e.bindVertexArray(null)),Object.keys(M.meta.regions).forEach(h=>{const R=M.meta.regions[h];if(!R.visible)return;const w=le.getRegionTransform(h),F=_e.multiply(he,w);M.uModel.set(F),e.bindVertexArray(R.vao),e.drawElements(e.TRIANGLES,R.indexCount,e.UNSIGNED_INT,0),e.bindVertexArray(null)}),e.useProgram(te.program),te.uModel.set(he),te.uView.set(me.view()),te.uProj.set(de),e.bindVertexArray(te.vao),e.drawArrays(e.LINES,0,te.meta.count),e.bindVertexArray(null);const E=le.getAllParticles();if(E.length>0){e.enable(e.BLEND),e.blendFunc(e.SRC_ALPHA,e.ONE_MINUS_SRC_ALPHA),e.useProgram(q.program),q.uPalette.set(p.colors),q.uView.set(me.view()),q.uProj.set(de),q.uLightDirWS.set(new Float32Array([.7/1.7,-1.2/1.7,.9/1.7])),q.uAmbient.set(Be),I(E),e.activeTexture(e.TEXTURE0),e.bindTexture(e.TEXTURE_2D,x),q.uParticleData.set(0),q.uTextureWidth.set(u),e.bindVertexArray(q.vao),e.drawElementsInstanced(e.TRIANGLES,fe.count,e.UNSIGNED_SHORT,0,E.length);const h=e.getError();h!==e.NO_ERROR&&console.error("Draw error:",h,"hex:",h.toString(16)),e.bindVertexArray(null),e.disable(e.BLEND)}Y();const[f,s,i]=N.coordsOf(U),l=N.idx3(f,s,i);N.isSolid(l)&&b(U,ee,1.006);for(const[h,R]of le.regions.entries())if(ye.get(h)){const[w,F,C]=R.min,[ne,v,k]=R.max;c(w,F,C,ne,v,k,Se===h?[.2,.6,1]:[.6,.8,.3],1.01)}requestAnimationFrame(r)}requestAnimationFrame(r),setTimeout(Z,0);const d={canvas:a,chunk:N,N:Le,palette:p,camera:me,animSystem:le,animationTransforms:Me,getHoverVoxel:()=>U,getHoverFace:()=>G,setNeedsPick:n=>{P=n},getDragging:()=>V,setDragging:n=>{V=n},getLastX:()=>Q,setLastX:n=>{Q=n},getLastY:()=>D,setLastY:n=>{D=n},setMouseX:n=>{z=n},setMouseY:n=>{O=n},getSelectedRegionName:()=>Se,setSelectedRegionName:n=>{Se=n},getRegionOverlaysVisible:()=>ye,setRegionOverlaysVisible:n=>{ye=n},buildAllMeshes:X,buildAxisGizmo:Re,exportToJSON:L,importFromJSON:K,decodePickAt:ie};ot(d),_=d.updateHoverUI}document.addEventListener("DOMContentLoaded",it);

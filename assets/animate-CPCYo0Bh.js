import{c as Le,l as Ue,f as ze,p as Oe,g as Ge,w as Xe,i as He,d as Ve,e as Ye,j as $e,k as We,m as qe,a as Je,V as Ze,O as je,t as Ie,M as Fe,P as Ke,b as Qe,A as et,h as tt,r as nt}from"./voxel-chunk-C2aVMRXz.js";class at extends HTMLElement{constructor(){super(),this._value=0,this._step=1,this._min=null,this._max=null}static get observedAttributes(){return["axis","value","step","min","max","label"]}connectedCallback(){this.className="shift-button-group",this.render()}attributeChangedCallback(e,p,R){if(p!==R){switch(e){case"value":this._value=parseFloat(R)||0;break;case"step":this._step=parseFloat(R)||1;break;case"min":this._min=R!==null?parseFloat(R):null;break;case"max":this._max=R!==null?parseFloat(R):null;break}this.isConnected&&this.render()}}get value(){return this._value}set value(e){const p=this._value;this._value=parseFloat(e)||0,this.setAttribute("value",this._value),this.dispatchEvent(new CustomEvent("change",{detail:{value:this._value,oldValue:p}}))}increment(){const e=this._value;let p=this._value+this._step;this._step<1&&(p=Math.round(p*10)/10),this._max!==null&&(p=Math.min(p,this._max)),this._value=p,this.setAttribute("value",this._value),this.render(),this.dispatchEvent(new CustomEvent("change",{detail:{value:this._value,oldValue:e}}))}decrement(){const e=this._value;let p=this._value-this._step;this._step<1&&(p=Math.round(p*10)/10),this._min!==null&&(p=Math.max(p,this._min)),this._value=p,this.setAttribute("value",this._value),this.render(),this.dispatchEvent(new CustomEvent("change",{detail:{value:this._value,oldValue:e}}))}render(){const e=this.getAttribute("axis");this.getAttribute("label"),this.innerHTML="";const p=document.createElement("button");p.className="shift-btn shift-minus",p.textContent="−",p.title=`Decrease by ${this._step}`,p.addEventListener("click",D=>{D.preventDefault(),this.decrement()});const R=document.createElement("span");R.className=e?`shift-label shift-${e}`:"shift-label";const P=document.createElement("span");P.className="shift-value",this._step<1?P.textContent=this._value.toFixed(1):P.textContent=this._value,R.appendChild(P);const k=document.createElement("button");k.className="shift-btn shift-plus",k.textContent="+",k.title=`Increase by ${this._step}`,k.addEventListener("click",D=>{D.preventDefault(),this.increment()}),this.appendChild(p),this.appendChild(R),this.appendChild(k)}}customElements.define("shift-button-group",at);class it extends HTMLElement{static get observedAttributes(){return["x","y","z","step","min","max"]}constructor(){super(),this._x=0,this._y=0,this._z=0,this._step=1,this._min=-1/0,this._max=1/0}connectedCallback(){this.render()}attributeChangedCallback(e,p,R){if(p!==R){switch(e){case"x":this._x=parseFloat(R)||0;break;case"y":this._y=parseFloat(R)||0;break;case"z":this._z=parseFloat(R)||0;break;case"step":this._step=parseFloat(R)||1;break;case"min":this._min=R!==null?parseFloat(R):-1/0;break;case"max":this._max=R!==null?parseFloat(R):1/0;break}this.isConnected&&this.render()}}get values(){return[this._x,this._y,this._z]}set values(e){Array.isArray(e)&&e.length===3&&(this._x=e[0],this._y=e[1],this._z=e[2],this.render())}render(){this.innerHTML="",this.style.display="flex",this.style.gap="8px",["x","y","z"].forEach((e,p)=>{const R=[this._x,this._y,this._z][p],P=document.createElement("shift-button-group");P.setAttribute("axis",e),P.setAttribute("value",R),P.setAttribute("step",this._step),this._min!==-1/0&&P.setAttribute("min",this._min),this._max!==1/0&&P.setAttribute("max",this._max),P.addEventListener("change",k=>{const D=[this._x,this._y,this._z];p===0&&(this._x=k.detail.value),p===1&&(this._y=k.detail.value),p===2&&(this._z=k.detail.value),this.dispatchEvent(new CustomEvent("change",{detail:{values:[this._x,this._y,this._z],oldValues:D,axis:e,index:p}}))}),this.appendChild(P)})}}customElements.define("xyz-control",it);function ot(a){const{canvas:e,chunk:p,N:R,palette:P,camera:k,animSystem:D,animationTransforms:_e,getHoverVoxel:xe,getHoverFace:he,setNeedsPick:oe,getDragging:Be,setDragging:Ne,getLastX:Ae,setLastX:be,getLastY:Re,setLastY:C,setMouseX:ce,setMouseY:fe,exportToJSON:de,importFromJSON:Te,decodePickAt:Se}=a,se=document.getElementById("x"),pe=document.getElementById("y"),ue=document.getElementById("z"),Ee=document.getElementById("fileInput");function ge(r,d,i={}){const l=document.createElement("shift-button-group");return l.setAttribute("value",r),i.axis&&l.setAttribute("axis",i.axis),i.step!==void 0&&l.setAttribute("step",i.step),i.min!==void 0&&l.setAttribute("min",i.min),i.max!==void 0&&l.setAttribute("max",i.max),i.label&&l.setAttribute("label",i.label),l.addEventListener("change",n=>{d(n.detail.value)}),l}function Ce(r,d,i={}){const l=document.createElement("xyz-control");return l.setAttribute("x",r[0]),l.setAttribute("y",r[1]),l.setAttribute("z",r[2]),i.step!==void 0&&l.setAttribute("step",i.step),i.min!==void 0&&l.setAttribute("min",i.min),i.max!==void 0&&l.setAttribute("max",i.max),l.addEventListener("change",n=>{d(n.detail.values)}),l}const ye=document.querySelector(".side-panel");window.addEventListener("keydown",r=>{r.key==="Escape"&&(ye.classList.contains("open")&&ye.classList.remove("open"),animPanel.classList.contains("open")&&animPanel.classList.remove("open"))}),document.getElementById("btnImport").addEventListener("click",()=>Ee.click()),document.getElementById("btnExport").addEventListener("click",()=>{const r=de(),d=new Blob([JSON.stringify(r,null,2)],{type:"application/json"}),i=URL.createObjectURL(d),l=document.createElement("a");l.href=i,l.download="voxels.json",l.click(),URL.revokeObjectURL(i)}),Ee.addEventListener("change",r=>{const d=r.target.files[0];if(!d)return;const i=new FileReader;i.onload=()=>{try{const l=JSON.parse(i.result);console.log("Importing JSON:",l),Te(l),ne(),me(),ie(),re();const n=document.querySelector(".animation-panel");n&&n.setAttribute("data-loaded","true")}catch(l){alert("Invalid JSON: "+l.message),console.error("Error importing JSON:",l)}finally{Ee.value=""}},i.readAsText(d)});function ke(){const r=xe(),d=he();if(r<0||d<0){se.textContent="-",pe.textContent="-",ue.textContent="-";return}const[i,l,n]=p.coordsOf(r);se.textContent=i,pe.textContent=l,ue.textContent=n}a.updateHoverUI=ke,e.addEventListener("contextmenu",r=>r.preventDefault()),e.addEventListener("mousedown",r=>{e.focus();const d=Se(r.clientX,r.clientY);if(d.voxel<0||d.face<0){r.button===0&&(Ne(!0),be(r.clientX),C(r.clientY));return}}),window.addEventListener("mouseup",()=>{Ne(!1)}),window.addEventListener("mousemove",r=>{const d=Be();if(d||(ce(r.clientX),fe(r.clientY),oe(!0)),d){const i=Ae(),l=Re(),n=r.clientX-i,_=r.clientY-l;be(r.clientX),C(r.clientY);const U=.005;k.theta+=n*U,k.phi-=_*U,k.clamp()}},{passive:!0}),e.addEventListener("wheel",r=>{r.preventDefault();const d=Math.pow(1.1,r.deltaY*.01);k.radius*=d,k.clamp()},{passive:!1});function ne(){const r=document.getElementById("animationList");if(r){if(r.innerHTML="",a.animSystem.animations.size===0&&a.animSystem.emitters.size===0&&a.animSystem.groups.size===0){const d=document.createElement("p");d.style.color="#888",d.style.fontSize="12px",d.style.margin="8px 0",d.textContent="No animations, emitters, or groups defined",r.appendChild(d);const i=document.createElement("button");i.textContent="+ Add Animation",i.className="add-animation-btn",i.addEventListener("click",()=>{const l=a.animSystem.generateUniqueAnimationName("anim");a.animSystem.addAnimation(l,null),ne()}),r.appendChild(i);return}if(a.animSystem.animations.size>0){const d=document.createElement("h5");d.textContent="Animations",d.style.margin="8px 0 4px 0",r.appendChild(d)}for(const[d,i]of a.animSystem.animations.entries()){const l=document.createElement("div");l.className="animation-item expanded";const n=document.createElement("div");n.className="animation-header";const _=document.createElement("div");_.className="animation-header-left";const U=document.createElement("span");if(U.className="animation-name",U.textContent=d,_.appendChild(U),i.loop){const o=document.createElement("span");o.className="animation-badge",o.textContent="loop",_.appendChild(o)}const q=document.createElement("div");q.className="animation-header-right";const X=document.createElement("div");X.className="animation-controls-inline";const J=document.createElement("button");J.textContent="▶",J.title="Play",J.className="animation-btn",J.addEventListener("click",()=>{a.animSystem.playAnimation(d)});const ee=document.createElement("button");ee.textContent="⏹",ee.title="Stop",ee.className="animation-btn",ee.addEventListener("click",()=>{a.animSystem.stopAnimation(d)});const z=document.createElement("button");z.textContent="↺",z.title="Reset",z.className="animation-btn",z.addEventListener("click",()=>{a.animSystem.resetAnimation(d)});const I=document.createElement("button");I.textContent="⎘",I.title="Duplicate animation",I.className="animation-btn keyframe-duplicate-btn",I.addEventListener("click",()=>{const o=a.animSystem.generateUniqueAnimationName(d),t=a.animSystem.addAnimation(o,i.regionName);t.loop=i.loop,t.keyframes=JSON.parse(JSON.stringify(i.keyframes)),ne()});const M=document.createElement("button");M.textContent="×",M.title="Delete animation",M.className="animation-btn delete-animation-btn",M.addEventListener("click",()=>{confirm(`Delete animation "${d}"?`)&&(a.animSystem.removeAnimation(d),ne())}),X.appendChild(J),X.appendChild(ee),X.appendChild(z),X.appendChild(I),X.appendChild(M),q.appendChild(X),n.appendChild(_),n.appendChild(q);const O=document.createElement("div");O.className="animation-form";const H=document.createElement("div");H.className="form-row";const j=document.createElement("label");j.textContent="Region:",j.className="form-label";const T=document.createElement("select");T.className="form-select";const V=document.createElement("option");V.value="",V.textContent="(none)",T.appendChild(V);for(const[o,t]of a.animSystem.regions.entries()){const m=document.createElement("option");m.value=o,m.textContent=o,m.selected=i.regionName===o,T.appendChild(m)}T.addEventListener("change",o=>{const t=o.target.value||null;i.regionName=t,t&&a.animSystem.regions.has(t)?i.region=a.animSystem.regions.get(t):i.region=null}),H.appendChild(j),H.appendChild(T);const ae=document.createElement("div");ae.className="form-row";const Y=document.createElement("input");Y.type="checkbox",Y.id=`anim-loop-${d}`,Y.checked=i.loop,Y.addEventListener("change",o=>{i.loop=o.target.checked,ne()});const L=document.createElement("label");L.htmlFor=`anim-loop-${d}`,L.textContent="Loop",L.className="form-checkbox-label",ae.appendChild(Y),ae.appendChild(L),O.appendChild(H),O.appendChild(ae);const te=document.createElement("div");te.className="keyframes-section";const y=document.createElement("div");y.className="keyframes-header";const N=document.createElement("h6");N.textContent="Keyframes",N.style.margin="0",N.style.fontSize="12px",N.style.color="#888",N.style.fontWeight="600",N.style.textTransform="uppercase";const Z=document.createElement("button");Z.textContent="+ Add",Z.className="add-keyframe-btn",Z.addEventListener("click",()=>{i.keyframes.push({type:"wait",duration:1}),ne()}),y.appendChild(N),y.appendChild(Z),te.appendChild(y);const $=document.createElement("div");$.className="keyframes-list",i.keyframes.forEach((o,t)=>{const m=document.createElement("div");m.className="keyframe-item";const E=document.createElement("div");E.className="keyframe-header";const v=document.createElement("span");v.className="keyframe-type-label",v.textContent=`${t+1}. ${o.type.toUpperCase()}`;const c=document.createElement("div");if(c.className="keyframe-buttons",t>0){const g=document.createElement("button");g.textContent="↑",g.className="keyframe-move-btn",g.title="Move keyframe up",g.addEventListener("click",()=>{[i.keyframes[t-1],i.keyframes[t]]=[i.keyframes[t],i.keyframes[t-1]],ne()}),c.appendChild(g)}if(t<i.keyframes.length-1){const g=document.createElement("button");g.textContent="↓",g.className="keyframe-move-btn",g.title="Move keyframe down",g.addEventListener("click",()=>{[i.keyframes[t],i.keyframes[t+1]]=[i.keyframes[t+1],i.keyframes[t]],ne()}),c.appendChild(g)}const h=document.createElement("button");h.textContent="⎘",h.className="keyframe-duplicate-btn",h.title="Duplicate keyframe",h.addEventListener("click",()=>{const g=JSON.parse(JSON.stringify(o));i.keyframes.splice(t+1,0,g),ne()});const b=document.createElement("button");b.textContent="×",b.className="keyframe-delete-btn",b.title="Delete keyframe",b.addEventListener("click",()=>{i.keyframes.splice(t,1),ne()}),c.appendChild(h),c.appendChild(b),E.appendChild(v),E.appendChild(c);const s=document.createElement("div");s.className="keyframe-form";const u=document.createElement("div");u.className="form-row";const B=document.createElement("label");B.textContent="Type:",B.className="form-label";const S=document.createElement("select");S.className="form-select",["wait","rotate","move"].forEach(g=>{const G=document.createElement("option");G.value=g,G.textContent=g,G.selected=o.type===g,S.appendChild(G)}),S.addEventListener("change",g=>{o.type;const G=g.target.value;G==="wait"?i.keyframes[t]={type:"wait",duration:o.duration||1}:G==="rotate"?i.keyframes[t]={type:"rotate",from:0,to:90,duration:o.duration||1,pivot:[0,0,0],axis:[0,1,0]}:G==="move"&&(i.keyframes[t]={type:"move",axis:"y",delta:1,duration:o.duration||1}),ne()}),u.appendChild(B),u.appendChild(S),s.appendChild(u);const w=document.createElement("div");w.className="form-row";const W=document.createElement("label");W.textContent="Duration:",W.className="form-label",(o.duration===void 0||o.duration===null)&&(o.duration=1);const x=ge(o.duration,g=>{o.duration=g},{step:.1,min:0});if(w.appendChild(W),w.appendChild(x),s.appendChild(w),o.type==="rotate"){const g=document.createElement("div");g.className="form-row";const G=document.createElement("label");G.textContent="From:",G.className="form-label",(o.from===void 0||o.from===null)&&(o.from=0);const K=ge(o.from,ve=>{o.from=ve},{step:1});g.appendChild(G),g.appendChild(K),s.appendChild(g);const A=document.createElement("div");A.className="form-row";const f=document.createElement("label");f.textContent="To:",f.className="form-label",(o.to===void 0||o.to===null)&&(o.to=0);const F=ge(o.to,ve=>{o.to=ve},{step:1});A.appendChild(f),A.appendChild(F),s.appendChild(A);const Q=document.createElement("div");Q.className="form-row";const le=document.createElement("label");le.textContent="Pivot:",le.className="form-label",(!o.pivot||!Array.isArray(o.pivot))&&(o.pivot=[0,0,0]);const Pe=Ce(o.pivot,ve=>{o.pivot=ve},{step:1});Q.appendChild(le),Q.appendChild(Pe),s.appendChild(Q);const we=document.createElement("div");we.className="form-row";const Me=document.createElement("label");Me.textContent="Axis:",Me.className="form-label",(!o.axis||!Array.isArray(o.axis))&&(o.axis=[0,1,0]);const De=Ce(o.axis,ve=>{o.axis=ve},{step:1});we.appendChild(Me),we.appendChild(De),s.appendChild(we)}else if(o.type==="move"){const g=document.createElement("div");g.className="form-row";const G=document.createElement("label");G.textContent="Axis:",G.className="form-label";const K=document.createElement("select");K.className="form-select",["x","y","z"].forEach(Q=>{const le=document.createElement("option");le.value=Q,le.textContent=Q.toUpperCase(),le.selected=o.axis===Q,K.appendChild(le)}),K.addEventListener("change",Q=>{o.axis=Q.target.value}),g.appendChild(G),g.appendChild(K),s.appendChild(g);const A=document.createElement("div");A.className="form-row";const f=document.createElement("label");f.textContent="Delta:",f.className="form-label";const F=document.createElement("input");F.type="number",F.className="form-input",F.step="0.1",F.value=o.delta||0,F.addEventListener("change",Q=>{o.delta=parseFloat(Q.target.value)||0}),A.appendChild(f),A.appendChild(F),s.appendChild(A)}if(o.type==="rotate"||o.type==="move"){const g=document.createElement("div");g.className="form-row";const G=document.createElement("label");G.textContent="Easing:",G.className="form-label";const K=document.createElement("select");if(K.className="form-select",["(none)","linear","ease-in","ease-out","ease-in-out","steps"].forEach(f=>{const F=document.createElement("option");F.value=f==="(none)"?"":f,F.textContent=f,F.selected=(o.easing||"")===(f==="(none)"?"":f),K.appendChild(F)}),K.addEventListener("change",f=>{f.target.value?o.easing=f.target.value:delete o.easing,ne()}),g.appendChild(G),g.appendChild(K),s.appendChild(g),o.easing==="steps"){const f=document.createElement("div");f.className="form-row";const F=document.createElement("label");F.textContent="Steps:",F.className="form-label";const Q=document.createElement("input");Q.type="number",Q.className="form-input",Q.min="1",Q.step="1",Q.value=o.steps||10,Q.addEventListener("change",le=>{o.steps=parseInt(le.target.value)||10}),f.appendChild(F),f.appendChild(Q),s.appendChild(f)}}m.appendChild(E),m.appendChild(s),$.appendChild(m)}),te.appendChild($),O.appendChild(te),l.appendChild(n),l.appendChild(O),r.appendChild(l)}if(a.animSystem.animations.size>0){const d=document.createElement("button");d.textContent="+ Add Animation",d.className="add-animation-btn",d.addEventListener("click",()=>{const i=a.animSystem.generateUniqueAnimationName("anim");a.animSystem.addAnimation(i,null),ne()}),r.appendChild(d)}}}function me(){const r=document.getElementById("emitterList");if(!r)return;r.innerHTML="";const d=document.createElement("button");if(d.textContent="+ Add Emitter",d.className="add-animation-btn",d.addEventListener("click",()=>{const l=a.animSystem.generateUniqueEmitterName("emitter");a.animSystem.addEmitter(l),me()}),r.appendChild(d),a.animSystem.emitters.size===0){const l=document.createElement("p");l.style.color="#888",l.style.fontSize="12px",l.style.margin="8px 0",l.textContent="No emitters defined",r.appendChild(l);return}const i=document.createElement("h5");i.textContent="Emitters",i.style.margin="8px 0 4px 0",r.appendChild(i);for(const[l,n]of a.animSystem.emitters.entries()){const _=document.createElement("div");_.className="animation-item expanded";const U=document.createElement("div");U.className="animation-header";const q=document.createElement("div");q.className="animation-header-left";const X=document.createElement("span");X.className="animation-name",X.textContent=l,q.appendChild(X);const J=document.createElement("span");if(J.className="animation-badge",J.textContent=`${n.particles.length} particles`,q.appendChild(J),n.enabled){const A=document.createElement("span");A.className="animation-badge",A.textContent="active",A.style.background="rgba(100, 200, 100, 0.3)",q.appendChild(A)}const ee=document.createElement("div");ee.className="animation-header-right";const z=document.createElement("div");z.className="animation-controls-inline";const I=document.createElement("button");I.textContent="▶",I.title="Start",I.className="animation-btn",I.addEventListener("click",()=>{a.animSystem.startEmitter(l),me()});const M=document.createElement("button");M.textContent="⏹",M.title="Stop",M.className="animation-btn",M.addEventListener("click",()=>{a.animSystem.stopEmitter(l),me()});const O=document.createElement("button");O.textContent="↺",O.title="Clear particles",O.className="animation-btn",O.addEventListener("click",()=>{a.animSystem.clearEmitter(l)});const H=document.createElement("button");H.textContent="⎘",H.title="Duplicate emitter",H.className="animation-btn keyframe-duplicate-btn",H.addEventListener("click",()=>{const A=a.animSystem.generateUniqueEmitterName(l),f=a.animSystem.addEmitter(A);f.position=[...n.position],f.rate=n.rate,f.particleLifetime=n.particleLifetime,f.particleSize=n.particleSize,f.velocityBase=[...n.velocityBase],f.velocitySpread=[...n.velocitySpread],f.colorIds=[...n.colorIds],f.gravity=[...n.gravity],f.maxParticles=n.maxParticles,me()});const j=document.createElement("button");j.textContent="×",j.title="Delete emitter",j.className="animation-btn delete-animation-btn",j.addEventListener("click",()=>{confirm(`Delete emitter "${l}"?`)&&(a.animSystem.removeEmitter(l),me())}),z.appendChild(I),z.appendChild(M),z.appendChild(O),z.appendChild(H),z.appendChild(j),ee.appendChild(z),U.appendChild(q),U.appendChild(ee);const T=document.createElement("div");T.className="animation-form";const V=document.createElement("div");V.className="form-row";const ae=document.createElement("label");ae.textContent="Position:",ae.className="form-label";const Y=document.createElement("input");Y.type="text",Y.className="form-input",Y.placeholder="0, 0, 0",Y.value=n.position.join(", "),Y.addEventListener("change",A=>{const f=A.target.value.split(",").map(F=>parseFloat(F.trim())||0);n.position=[f[0]||0,f[1]||0,f[2]||0]}),V.appendChild(ae),V.appendChild(Y),T.appendChild(V);const L=document.createElement("div");L.className="form-row";const te=document.createElement("label");te.textContent="Rate:",te.className="form-label";const y=document.createElement("input");y.type="number",y.className="form-input",y.min="0",y.step="1",y.value=n.rate,y.title="Particles per second",y.addEventListener("change",A=>{n.rate=parseFloat(A.target.value)||10}),L.appendChild(te),L.appendChild(y),T.appendChild(L);const N=document.createElement("div");N.className="form-row";const Z=document.createElement("label");Z.textContent="Lifetime:",Z.className="form-label";const $=document.createElement("input");$.type="number",$.className="form-input",$.min="0",$.step="0.1",$.value=n.particleLifetime,$.title="How long each particle lives (seconds)",$.addEventListener("change",A=>{n.particleLifetime=parseFloat(A.target.value)||2}),N.appendChild(Z),N.appendChild($),T.appendChild(N);const o=document.createElement("div");o.className="form-row";const t=document.createElement("label");t.textContent="Size:",t.className="form-label";const m=document.createElement("input");m.type="number",m.className="form-input",m.min="0",m.step="0.1",m.value=n.particleSize,m.title="Size of each particle cube",m.addEventListener("change",A=>{n.particleSize=parseFloat(A.target.value)||.2}),o.appendChild(t),o.appendChild(m),T.appendChild(o);const E=document.createElement("div");E.className="form-row";const v=document.createElement("label");v.textContent="Velocity:",v.className="form-label";const c=document.createElement("input");c.type="text",c.className="form-input",c.placeholder="0, 5, 0",c.value=n.velocityBase.join(", "),c.title="Base velocity vector",c.addEventListener("change",A=>{const f=A.target.value.split(",").map(F=>parseFloat(F.trim())||0);n.velocityBase=[f[0]||0,f[1]||0,f[2]||0]}),E.appendChild(v),E.appendChild(c),T.appendChild(E);const h=document.createElement("div");h.className="form-row";const b=document.createElement("label");b.textContent="Spread:",b.className="form-label";const s=document.createElement("input");s.type="text",s.className="form-input",s.placeholder="1, 1, 1",s.value=n.velocitySpread.join(", "),s.title="Random velocity spread amount",s.addEventListener("change",A=>{const f=A.target.value.split(",").map(F=>parseFloat(F.trim())||0);n.velocitySpread=[f[0]||0,f[1]||0,f[2]||0]}),h.appendChild(b),h.appendChild(s),T.appendChild(h);const u=document.createElement("div");u.className="form-row";const B=document.createElement("label");B.textContent="Colors:",B.className="form-label";const S=document.createElement("input");S.type="text",S.className="form-input",S.placeholder="0, 1, 2",S.value=n.colorIds.join(", "),S.title="Material IDs to randomly use (0-15)",S.addEventListener("change",A=>{const f=A.target.value.split(",").map(F=>Math.floor(parseFloat(F.trim()))||0);n.colorIds=f.filter(F=>F>=0&&F<=15),n.colorIds.length===0&&(n.colorIds=[0])}),u.appendChild(B),u.appendChild(S),T.appendChild(u);const w=document.createElement("div");w.className="form-row";const W=document.createElement("label");W.textContent="Gravity:",W.className="form-label";const x=document.createElement("input");x.type="text",x.className="form-input",x.placeholder="0, -9.8, 0",x.value=n.gravity.join(", "),x.title="Gravity acceleration vector",x.addEventListener("change",A=>{const f=A.target.value.split(",").map(F=>parseFloat(F.trim())||0);n.gravity=[f[0]||0,f[1]||0,f[2]||0]}),w.appendChild(W),w.appendChild(x),T.appendChild(w);const g=document.createElement("div");g.className="form-row";const G=document.createElement("label");G.textContent="Max Particles:",G.className="form-label";const K=document.createElement("input");K.type="number",K.className="form-input",K.min="1",K.step="1",K.value=n.maxParticles,K.title="Maximum number of particles (safety limit)",K.addEventListener("change",A=>{n.maxParticles=parseInt(A.target.value)||1e3}),g.appendChild(G),g.appendChild(K),T.appendChild(g),_.appendChild(U),_.appendChild(T),r.appendChild(_)}}function ie(){const r=document.getElementById("groupList");if(!r)return;r.innerHTML="";const d=document.createElement("button");if(d.textContent="+ Add Group",d.className="add-animation-btn",d.addEventListener("click",()=>{const l=a.animSystem.generateUniqueGroupName("group");a.animSystem.addGroup(l),ie()}),r.appendChild(d),a.animSystem.groups.size===0){const l=document.createElement("p");l.style.color="#888",l.style.fontSize="12px",l.style.margin="8px 0",l.textContent="No groups defined",r.appendChild(l);return}const i=document.createElement("h5");i.textContent="Groups",i.style.margin="8px 0 4px 0",r.appendChild(i);for(const[l,n]of a.animSystem.groups.entries()){const _=document.createElement("div");_.className="animation-item expanded";const U=document.createElement("div");U.className="animation-header";const q=document.createElement("div");q.className="animation-header-left";const X=document.createElement("span");X.className="animation-name",X.textContent=l,q.appendChild(X);const J=document.createElement("span");J.className="animation-badge";const ee=n.animationNames.length+n.emitterNames.length;J.textContent=`${ee} items`,q.appendChild(J);const z=document.createElement("div");z.className="animation-header-right";const I=document.createElement("div");I.className="animation-controls-inline";const M=document.createElement("button");M.textContent="▶",M.title="Play group",M.className="animation-btn",M.addEventListener("click",()=>{a.animSystem.playGroup(l)});const O=document.createElement("button");O.textContent="⏹",O.title="Stop group",O.className="animation-btn",O.addEventListener("click",()=>{a.animSystem.stopGroup(l)});const H=document.createElement("button");H.textContent="↺",H.title="Reset group",H.className="animation-btn",H.addEventListener("click",()=>{a.animSystem.resetGroup(l)});const j=document.createElement("button");j.textContent="⎘",j.title="Duplicate group",j.className="animation-btn keyframe-duplicate-btn",j.addEventListener("click",()=>{const s=a.animSystem.generateUniqueGroupName(l),u=a.animSystem.addGroup(s);u.animationNames=[...n.animationNames],u.emitterNames=[...n.emitterNames],ie()});const T=document.createElement("button");T.textContent="×",T.title="Delete group",T.className="animation-btn delete-animation-btn",T.addEventListener("click",()=>{confirm(`Delete group "${l}"?`)&&(a.animSystem.removeGroup(l),ie())}),I.appendChild(M),I.appendChild(O),I.appendChild(H),I.appendChild(j),I.appendChild(T),z.appendChild(I),U.appendChild(q),U.appendChild(z);const V=document.createElement("div");V.className="animation-form";const ae=document.createElement("div");ae.className="form-row";const Y=document.createElement("label");Y.textContent="Guard State:",Y.className="form-label";const L=document.createElement("input");L.type="text",L.className="form-input",L.placeholder="(none)",L.value=n.guard||"",L.addEventListener("change",s=>{n.guard=s.target.value||null}),ae.appendChild(Y),ae.appendChild(L),V.appendChild(ae);const te=document.createElement("div");te.className="form-row";const y=document.createElement("label");y.textContent="End State:",y.className="form-label";const N=document.createElement("input");N.type="text",N.className="form-input",N.placeholder="(none)",N.value=n.endState||"",N.addEventListener("change",s=>{n.endState=s.target.value||null}),te.appendChild(y),te.appendChild(N),V.appendChild(te);const Z=document.createElement("div");Z.className="group-section";const $=document.createElement("div");$.className="group-section-header";const o=document.createElement("h6");o.textContent="Animations",o.style.margin="0",o.style.fontSize="12px",o.style.color="#888",o.style.fontWeight="600",o.style.textTransform="uppercase";const t=document.createElement("button");t.textContent="+",t.className="group-add-btn",t.title="Add animation to group",t.addEventListener("click",()=>{const s=Array.from(a.animSystem.animations.keys()).filter(u=>!n.animationNames.includes(u));if(s.length===0){alert("No animations available to add");return}n.addAnimation(s[0]),ie()}),$.appendChild(o),$.appendChild(t),Z.appendChild($);const m=document.createElement("div");if(m.className="group-item-list",n.animationNames.length===0){const s=document.createElement("p");s.style.color="#666",s.style.fontSize="11px",s.style.margin="4px 0",s.style.fontStyle="italic",s.textContent="No animations",m.appendChild(s)}else n.animationNames.forEach((s,u)=>{const B=document.createElement("div");B.className="group-item";const S=document.createElement("span");S.textContent=s,S.style.fontSize="12px",S.style.color="#cfd3dc";const w=document.createElement("div");if(w.className="group-item-buttons",u>0){const x=document.createElement("button");x.textContent="↑",x.className="keyframe-move-btn",x.title="Move up",x.addEventListener("click",()=>{[n.animationNames[u-1],n.animationNames[u]]=[n.animationNames[u],n.animationNames[u-1]],ie()}),w.appendChild(x)}if(u<n.animationNames.length-1){const x=document.createElement("button");x.textContent="↓",x.className="keyframe-move-btn",x.title="Move down",x.addEventListener("click",()=>{[n.animationNames[u],n.animationNames[u+1]]=[n.animationNames[u+1],n.animationNames[u]],ie()}),w.appendChild(x)}const W=document.createElement("button");W.textContent="×",W.className="group-remove-btn",W.title="Remove from group",W.addEventListener("click",()=>{n.animationNames.splice(u,1),ie()}),w.appendChild(W),B.appendChild(S),B.appendChild(w),m.appendChild(B)});Z.appendChild(m),V.appendChild(Z);const E=document.createElement("div");E.className="group-section";const v=document.createElement("div");v.className="group-section-header";const c=document.createElement("h6");c.textContent="Emitters",c.style.margin="0",c.style.fontSize="12px",c.style.color="#888",c.style.fontWeight="600",c.style.textTransform="uppercase";const h=document.createElement("button");h.textContent="+",h.className="group-add-btn",h.title="Add emitter to group",h.addEventListener("click",()=>{const s=Array.from(a.animSystem.emitters.keys()).filter(u=>!n.emitterNames.includes(u));if(s.length===0){alert("No emitters available to add");return}n.addEmitter(s[0]),ie()}),v.appendChild(c),v.appendChild(h),E.appendChild(v);const b=document.createElement("div");if(b.className="group-item-list",n.emitterNames.length===0){const s=document.createElement("p");s.style.color="#666",s.style.fontSize="11px",s.style.margin="4px 0",s.style.fontStyle="italic",s.textContent="No emitters",b.appendChild(s)}else n.emitterNames.forEach((s,u)=>{const B=document.createElement("div");B.className="group-item";const S=document.createElement("span");S.textContent=s,S.style.fontSize="12px",S.style.color="#cfd3dc";const w=document.createElement("div");if(w.className="group-item-buttons",u>0){const x=document.createElement("button");x.textContent="↑",x.className="keyframe-move-btn",x.title="Move up",x.addEventListener("click",()=>{[n.emitterNames[u-1],n.emitterNames[u]]=[n.emitterNames[u],n.emitterNames[u-1]],ie()}),w.appendChild(x)}if(u<n.emitterNames.length-1){const x=document.createElement("button");x.textContent="↓",x.className="keyframe-move-btn",x.title="Move down",x.addEventListener("click",()=>{[n.emitterNames[u],n.emitterNames[u+1]]=[n.emitterNames[u+1],n.emitterNames[u]],ie()}),w.appendChild(x)}const W=document.createElement("button");W.textContent="×",W.className="group-remove-btn",W.title="Remove from group",W.addEventListener("click",()=>{n.emitterNames.splice(u,1),ie()}),w.appendChild(W),B.appendChild(S),B.appendChild(w),b.appendChild(B)});E.appendChild(b),V.appendChild(E),_.appendChild(U),_.appendChild(V),r.appendChild(_)}}function re(){const r=document.getElementById("regionList");if(!r)return;if(r.innerHTML="",a.animSystem.regions.size===0){const n=document.createElement("p");n.style.color="#888",n.style.fontSize="12px",n.style.margin="8px 0",n.textContent="No regions defined",r.appendChild(n);return}if(a.animSystem.regions.size>0){const n=document.createElement("h5");n.textContent="Regions",n.style.margin="8px 0 4px 0",r.appendChild(n)}const d=a.getRegionOverlaysVisible(),i=a.getSelectedRegionName();for(const[n,_]of a.animSystem.regions.entries()){const U=document.createElement("div");U.className="region-item",i===n&&U.classList.add("selected");const q=document.createElement("div");q.className="region-header";const X=document.createElement("input");X.type="text",X.className="region-name-input",X.value=n,X.addEventListener("change",y=>{const N=y.target.value.trim();if(!N){alert("Region name cannot be empty"),y.target.value=n;return}if(N!==n)try{const Z=d.get(n)||!1;a.animSystem.renameRegion(n,N),d.delete(n),Z&&d.set(N,Z),i===n&&a.setSelectedRegionName(N),a.chunk.clearRegions(),a.animSystem.regions.forEach(($,o)=>{a.chunk.addRegion(o,$.min,$.max)}),a.animSystem.assignVoxelsToRegions(a.chunk),a.buildAllMeshes(),re(),ne()}catch(Z){alert(Z.message),y.target.value=n}});const J=document.createElement("div");J.className="region-header-controls";const ee=document.createElement("div");ee.className="region-toggle";const z=document.createElement("input");z.type="checkbox",z.id=`region-vis-${n}`,z.checked=d.get(n)||!1,z.addEventListener("change",y=>{d.set(n,y.target.checked),y.target.checked&&(a.setSelectedRegionName(n),re())});const I=document.createElement("label");I.htmlFor=`region-vis-${n}`,I.textContent="Show",ee.appendChild(z),ee.appendChild(I);const M=document.createElement("button");M.textContent="⎘",M.className="duplicate-region-btn",M.title="Duplicate region",M.addEventListener("click",()=>{const y=a.animSystem.generateUniqueRegionName(n);a.animSystem.addRegion(y,[..._.min],[..._.max]),a.chunk.clearRegions(),a.animSystem.regions.forEach((N,Z)=>{a.chunk.addRegion(Z,N.min,N.max)}),a.animSystem.assignVoxelsToRegions(a.chunk),a.buildAllMeshes(),re()});const O=document.createElement("button");O.textContent="×",O.className="delete-region-btn",O.title="Delete region",O.addEventListener("click",()=>{confirm(`Delete region "${n}"? This will also remove any animations using this region.`)&&(a.animSystem.removeRegion(n),d.delete(n),i===n&&a.setSelectedRegionName(null),a.chunk.clearRegions(),a.animSystem.regions.forEach((y,N)=>{a.chunk.addRegion(N,y.min,y.max)}),a.animSystem.assignVoxelsToRegions(a.chunk),a.buildAllMeshes(),re(),ne())}),J.appendChild(ee),J.appendChild(M),J.appendChild(O),q.appendChild(X),q.appendChild(J);const H=document.createElement("div");H.className="region-bounds";const j=()=>{a.chunk.clearRegions(),a.animSystem.regions.forEach((y,N)=>{a.chunk.addRegion(N,y.min,y.max)}),a.animSystem.assignVoxelsToRegions(a.chunk),a.buildAllMeshes()},T=document.createElement("div");T.className="form-row";const V=document.createElement("label");V.className="form-label",V.textContent="Min:",T.appendChild(V);const ae=Ce(_.min,y=>{_.min=y,j(),re()},{step:1,min:0,max:255});T.appendChild(ae),H.appendChild(T);const Y=document.createElement("div");Y.className="form-row";const L=document.createElement("label");L.className="form-label",L.textContent="Max:",Y.appendChild(L);const te=Ce(_.max,y=>{_.max=y,j(),re()},{step:1,min:0,max:255});Y.appendChild(te),H.appendChild(Y),U.appendChild(q),U.appendChild(H),r.appendChild(U)}const l=document.createElement("button");l.textContent="+ Add Region",l.className="add-region-btn",l.addEventListener("click",()=>{const n=a.animSystem.generateUniqueRegionName("region");a.animSystem.addRegion(n,[0,0,0],[1,1,1]),a.chunk.clearRegions(),a.animSystem.regions.forEach((_,U)=>{a.chunk.addRegion(U,_.min,_.max)}),a.animSystem.assignVoxelsToRegions(a.chunk),a.buildAllMeshes(),re(),ne()}),r.appendChild(l)}document.getElementById("btnPlay")?.addEventListener("click",()=>{for(const[r,d]of a.animSystem.animations.entries())d.loop&&a.animSystem.playAnimation(r);for(const[r,d]of a.animSystem.emitters.entries())a.animSystem.startEmitter(r)}),document.getElementById("btnPause")?.addEventListener("click",()=>{for(const r of a.animSystem.animations.values())r.stop();for(const r of a.animSystem.emitters.values())r.stop()}),document.getElementById("btnResetAll")?.addEventListener("click",()=>{a.animSystem.resetAll()})}function st(){const a=document.getElementById("gl"),e=a.getContext("webgl2",{antialias:!0,alpha:!1});if(!e){alert("WebGL2 not supported");return}e.enable(e.DEPTH_TEST),e.enable(e.CULL_FACE),e.cullFace(e.BACK);const p=Le(e,ze,Ue);p.meta.visible=!0,p.meta.regions={};const R=Le(e,Ge,Oe),P=Le(e,He,Xe),k=Le(e,Ye,Ve),D=Le(e,We,$e),_e=qe();e.bindVertexArray(P.vao),e.bindBuffer(e.ARRAY_BUFFER,e.createBuffer()),e.bufferData(e.ARRAY_BUFFER,_e.positions,e.STATIC_DRAW),e.enableVertexAttribArray(P.aPosition.location),e.vertexAttribPointer(P.aPosition.location,3,e.FLOAT,!1,0,0),e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,e.createBuffer()),e.bufferData(e.ELEMENT_ARRAY_BUFFER,_e.indices,e.STATIC_DRAW),e.bindVertexArray(null);function xe(){const t=Qe(C.sizeX,C.sizeZ);e.bindVertexArray(k.vao),e.bindBuffer(e.ARRAY_BUFFER,e.createBuffer()),e.bufferData(e.ARRAY_BUFFER,t.positions,e.STATIC_DRAW),e.enableVertexAttribArray(k.aPosition.location),e.vertexAttribPointer(k.aPosition.location,3,e.FLOAT,!1,0,0),e.bindBuffer(e.ARRAY_BUFFER,e.createBuffer()),e.bufferData(e.ARRAY_BUFFER,t.colors,e.STATIC_DRAW),e.enableVertexAttribArray(k.aColor.location),e.vertexAttribPointer(k.aColor.location,3,e.FLOAT,!1,0,0),e.bindVertexArray(null),k.meta.count=t.count}const he=Je();if(e.bindVertexArray(D.vao),D.aPosition&&(e.bindBuffer(e.ARRAY_BUFFER,e.createBuffer()),e.bufferData(e.ARRAY_BUFFER,he.positions,e.STATIC_DRAW),e.enableVertexAttribArray(D.aPosition.location),e.vertexAttribPointer(D.aPosition.location,3,e.FLOAT,!1,0,0)),D.aNormal&&(e.bindBuffer(e.ARRAY_BUFFER,e.createBuffer()),e.bufferData(e.ARRAY_BUFFER,he.normals,e.STATIC_DRAW),e.enableVertexAttribArray(D.aNormal.location),e.vertexAttribPointer(D.aNormal.location,3,e.FLOAT,!1,0,0)),D.aMatId){const t=new Uint8Array(he.positions.length/3);e.bindBuffer(e.ARRAY_BUFFER,e.createBuffer()),e.bufferData(e.ARRAY_BUFFER,t,e.STATIC_DRAW),e.enableVertexAttribArray(D.aMatId.location),e.vertexAttribIPointer(D.aMatId.location,1,e.UNSIGNED_BYTE,0,0)}e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,e.createBuffer()),e.bufferData(e.ELEMENT_ARRAY_BUFFER,he.indices,e.STATIC_DRAW),e.bindVertexArray(null);const oe=new et;let Be=new Map,Ne=0,Ae=null,be=new Map,Re=16;const C=new Ze(Re);C.seedMaterials("bands"),xe();const ce=new je({target:[8,8,8],radius:40,theta:Ie(215),phi:Ie(60)}),fe=Fe.identity();let de=Fe.perspective(60*Math.PI/180,1,.01,100);const Te=.22;let Se=1,se=null,pe=null,ue=null,Ee=0,ge=0;function Ce(){const t=a.width,m=a.height;t===Ee&&m===ge&&se||(pe&&e.deleteTexture(pe),ue&&e.deleteRenderbuffer(ue),se&&e.deleteFramebuffer(se),pe=e.createTexture(),e.bindTexture(e.TEXTURE_2D,pe),e.texImage2D(e.TEXTURE_2D,0,e.RGBA8,t,m,0,e.RGBA,e.UNSIGNED_BYTE,null),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),ue=e.createRenderbuffer(),e.bindRenderbuffer(e.RENDERBUFFER,ue),e.renderbufferStorage(e.RENDERBUFFER,e.DEPTH_COMPONENT16,t,m),se=e.createFramebuffer(),e.bindFramebuffer(e.FRAMEBUFFER,se),e.framebufferTexture2D(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.TEXTURE_2D,pe,0),e.framebufferRenderbuffer(e.FRAMEBUFFER,e.DEPTH_ATTACHMENT,e.RENDERBUFFER,ue),e.bindFramebuffer(e.FRAMEBUFFER,null),Ee=t,ge=m)}function ye(){Se=Math.max(1,Math.min(2,window.devicePixelRatio||1));const t=a.clientWidth||a.parentElement.clientWidth,m=a.clientHeight||a.parentElement.clientHeight;a.width=Math.round(t*Se),a.height=Math.round(m*Se),e.viewport(0,0,a.width,a.height),de=Fe.perspective(60*Math.PI/180,a.width/a.height,.01,100),Ce()}window.addEventListener("resize",ye,{passive:!0}),requestAnimationFrame(ye);function ke(){e.bindFramebuffer(e.FRAMEBUFFER,se),e.viewport(0,0,Ee,ge),e.clearColor(0,0,0,1),e.clear(e.COLOR_BUFFER_BIT|e.DEPTH_BUFFER_BIT);const t=e.isEnabled(e.CULL_FACE);t&&e.disable(e.CULL_FACE),e.useProgram(R.program),R.uModel.set(fe),R.uView.set(ce.view()),R.uProj.set(de),e.bindVertexArray(R.vao),e.drawElements(e.TRIANGLES,R.meta.pickVoxelCount,e.UNSIGNED_INT,0),e.bindVertexArray(null),t&&e.enable(e.CULL_FACE),e.bindFramebuffer(e.FRAMEBUFFER,null)}function ne(t,m){const E=a.getBoundingClientRect(),v=Math.floor((t-E.left)*(a.width/E.width)),c=Math.floor((E.height-(m-E.top))*(a.height/E.height));return{x:v,y:c}}function me(t,m){if(R.meta.pickVoxelCount===0&&R.meta.pickGroundCount===0)return{voxel:-1,face:-1};ke();const{x:E,y:v}=ne(t,m),c=new Uint8Array(4);e.bindFramebuffer(e.FRAMEBUFFER,se),e.readPixels(E,v,1,1,e.RGBA,e.UNSIGNED_BYTE,c),e.bindFramebuffer(e.FRAMEBUFFER,null);const h=c[0]|c[1]<<8|c[2]<<16;if(h===0)return{voxel:-1,face:-1};const b=h&7,s=(h>>4)-1;return s<0||s>=C.length?{voxel:-1,face:-1}:{voxel:s,face:b}}function ie(t,m,E,v,c,h,b,s=1.006){const u=v-t+1,B=c-m+1,S=h-E+1,w=t+u*.5,W=m+B*.5,x=E+S*.5;e.useProgram(P.program),P.uModel.set(fe),P.uView.set(ce.view()),P.uProj.set(de),P.uOffset.set(new Float32Array([w,W,x])),P.uScaleVec.set(new Float32Array([u,B,S])),P.uInflate.set(s),P.uColor.set(new Float32Array(b)),e.bindVertexArray(P.vao),e.drawElements(e.LINES,_e.count,e.UNSIGNED_SHORT,0),e.bindVertexArray(null)}function re(t,m,E=1.006){const[v,c,h]=C.coordsOf(t);ie(v,c,h,v,c,h,m,E)}const r=new Ke(null,t=>{},(t,m,E)=>{const v=beginPaletteAction(`Palette ${t}`);recordPaletteChange(v,t,m,E),commitAction(v,!1)});function d(t){return t>=0&&t<=9?String.fromCharCode(48+t):t>=10&&t<=15?String.fromCharCode(97+(t-10)):"0"}function i(t){return Math.max(0,Math.min(255,t)).toString(16).padStart(2,"0")}function l(){const t=[];for(let c=0;c<16;c++)t.push(nt(r.colors[c*3+0],r.colors[c*3+1],r.colors[c*3+2]));const m=[],v=Math.max(C.sizeX,C.sizeY,C.sizeZ)<=16;for(let c=0;c<C.sizeZ;c++)for(let h=0;h<C.sizeY;h++)for(let b=0;b<C.sizeX;b++){const s=C.idx3(b,h,c);C.isSolid(s)&&(v?m.push(`${d(b)}${d(h)}${d(c)}${d(C.material(s))}`):m.push(`${i(b)}${i(h)}${i(c)}${d(C.material(s))}`))}return Object.assign({version:1,size:[C.sizeX,C.sizeY,C.sizeZ],palette:t,voxels:m},oe.toJSON())}function n(t){const m=t.toLowerCase();return m>="0"&&m<="9"?m.charCodeAt(0)-48:m>="a"&&m<="f"?10+(m.charCodeAt(0)-97):0}function _(t){return parseInt(t,16)||0}function U(t){if(!t||typeof t!="object")throw new Error("Root must be object");if(!Array.isArray(t.voxels))throw new Error('Missing "voxels"');let m,E,v;if(Array.isArray(t.size)){if(t.size.length!==3)throw new Error("Size array must have 3 elements [x, y, z]");[m,E,v]=t.size}else if(typeof t.size=="number")m=E=v=t.size;else throw new Error('Invalid "size" field');if(m===16&&E===16&&v===16?C.resetSize():(C.resetSize(),C.expandSize(m,E,v)),Re=Math.max(m,E,v),ce.target=[m/2,E/2,v/2],xe(),Array.isArray(t.palette))for(let c=0;c<Math.min(16,t.palette.length);c++){const h=t.palette[c];let b;typeof h=="string"?b=tt(h):Array.isArray(h)&&h.length>=3&&(b=[+h[0],+h[1],+h[2]]),b&&r.setPaletteColor(c,[Math.max(0,Math.min(1,b[0])),Math.max(0,Math.min(1,b[1])),Math.max(0,Math.min(1,b[2]))])}C.fill(!1),C.setMaterialAll(0);for(const c of t.voxels){if(!c)continue;let h,b,s,u;if(typeof c=="string")if(c.length===4)h=n(c[0]),b=n(c[1]),s=n(c[2]),u=(n(c[3])|0)&15;else if(c.length===7)h=_(c.substring(0,2)),b=_(c.substring(2,4)),s=_(c.substring(4,6)),u=(n(c[6])|0)&15;else continue;else if(Array.isArray(c)&&c.length>=4)[h,b,s,u]=c;else continue;if(C.within(h,b,s)){const B=C.idx3(h,b,s);C.setSolid(B,!0),C.setMaterial(B,u)}}C.clearRegions(),console.log(t),t.regions&&(oe.fromJSON(t),oe.assignVoxelsToRegions(C),oe.regions.forEach((c,h)=>{C.addRegion(h,c.min,c.max)})),V()}let q=!1,X=0,J=0,ee=0,z=0,I=!0,M=-1,O=-1,H=()=>{};function j(){if(!I)return;I=!1;const t=me(ee,z);M=t.voxel,O=t.face,H()}const T=[0,0,0];function V(){p.meta.renderIndexCount=C.buildGreedyRenderMeshMain(e,p,p.vao),C.buildPickFaces(e,R),p.meta.regions={};for(const[t,m]of oe.regions.entries())p.meta.regions[t]={},p.meta.regions[t].vao=e.createVertexArray(),p.meta.regions[t].visible=!0,p.meta.regions[t].indexCount=C.buildGreedyRenderMeshRegion(e,p,p.meta.regions[t].vao,t)}V();const ae=1e3,Y=2,L=64,te=Math.ceil(ae*Y/L),y=e.createTexture();e.bindTexture(e.TEXTURE_2D,y),e.texImage2D(e.TEXTURE_2D,0,e.RGBA32F,L,te,0,e.RGBA,e.FLOAT,null),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE);const N=e.getError();N!==e.NO_ERROR&&console.error("Texture creation error:",N);function Z(t){const m=new Float32Array(L*te*4);for(let E=0;E<t.length;E++){const v=t[E],c=E*2,h=E*2+1,b=c%L,s=Math.floor(c/L),u=h%L,B=Math.floor(h/L),S=(s*L+b)*4,w=(B*L+u)*4;m[S+0]=v.position[0],m[S+1]=v.position[1],m[S+2]=v.position[2],m[S+3]=v.size,m[w+0]=v.color/255,m[w+1]=v.getAlpha(),m[w+2]=0,m[w+3]=0}e.bindTexture(e.TEXTURE_2D,y),e.texSubImage2D(e.TEXTURE_2D,0,0,0,L,te,e.RGBA,e.FLOAT,m)}function $(){const t=performance.now(),m=(t-Ne)/1e3;Ne=t,oe.update(m),e.clearColor(.07,.08,.1,1),e.clear(e.COLOR_BUFFER_BIT|e.DEPTH_BUFFER_BIT),e.useProgram(p.program),p.uPalette.set(r.colors),p.uView.set(ce.view()),p.uProj.set(de),p.uNormalMat.set(new Float32Array([1,0,0,0,1,0,0,0,1])),p.uLightDirWS.set(new Float32Array([.7/1.7,-1.2/1.7,.9/1.7])),p.uAmbient.set(Te),p.meta.visible&&(p.uModel.set(fe),e.bindVertexArray(p.vao),e.drawElements(e.TRIANGLES,p.meta.renderIndexCount,e.UNSIGNED_INT,0),e.bindVertexArray(null)),Object.keys(p.meta.regions).forEach(s=>{const u=p.meta.regions[s];if(!u.visible)return;const B=oe.getRegionTransform(s),S=Fe.multiply(fe,B);p.uModel.set(S),e.bindVertexArray(u.vao),e.drawElements(e.TRIANGLES,u.indexCount,e.UNSIGNED_INT,0),e.bindVertexArray(null)}),e.useProgram(k.program),k.uModel.set(fe),k.uView.set(ce.view()),k.uProj.set(de),e.bindVertexArray(k.vao),e.drawArrays(e.LINES,0,k.meta.count),e.bindVertexArray(null);const E=oe.getAllParticles();if(E.length>0){e.enable(e.BLEND),e.blendFunc(e.SRC_ALPHA,e.ONE_MINUS_SRC_ALPHA),e.useProgram(D.program),D.uPalette.set(r.colors),D.uView.set(ce.view()),D.uProj.set(de),D.uLightDirWS.set(new Float32Array([.7/1.7,-1.2/1.7,.9/1.7])),D.uAmbient.set(Te),Z(E),e.activeTexture(e.TEXTURE0),e.bindTexture(e.TEXTURE_2D,y),D.uParticleData.set(0),D.uTextureWidth.set(L),e.bindVertexArray(D.vao),e.drawElementsInstanced(e.TRIANGLES,he.count,e.UNSIGNED_SHORT,0,E.length);const s=e.getError();s!==e.NO_ERROR&&console.error("Draw error:",s,"hex:",s.toString(16)),e.bindVertexArray(null),e.disable(e.BLEND)}j();const[v,c,h]=C.coordsOf(M),b=C.idx3(v,c,h);C.isSolid(b)&&re(M,T,1.006);for(const[s,u]of oe.regions.entries())if(be.get(s)){const[B,S,w]=u.min,[W,x,g]=u.max;ie(B,S,w,W,x,g,Ae===s?[.2,.6,1]:[.6,.8,.3],1.01)}requestAnimationFrame($)}requestAnimationFrame($),setTimeout(ye,0);const o={canvas:a,chunk:C,N:Re,palette:r,camera:ce,animSystem:oe,animationTransforms:Be,getHoverVoxel:()=>M,getHoverFace:()=>O,setNeedsPick:t=>{I=t},getDragging:()=>q,setDragging:t=>{q=t},getLastX:()=>X,setLastX:t=>{X=t},getLastY:()=>J,setLastY:t=>{J=t},setMouseX:t=>{ee=t},setMouseY:t=>{z=t},getSelectedRegionName:()=>Ae,setSelectedRegionName:t=>{Ae=t},getRegionOverlaysVisible:()=>be,setRegionOverlaysVisible:t=>{be=t},buildAllMeshes:V,buildAxisGizmo:xe,exportToJSON:l,importFromJSON:U,decodePickAt:me};ot(o),H=o.updateHoverUI}document.addEventListener("DOMContentLoaded",st);

import{c as Fe,m as ft,a as pt,V as Et,O as gt,t as ut,M as Je,P as xt,h as rt,A as ht,b as vt,d as At,e as yt,l as bt,f as Ct,p as Rt,g as St,w as Tt,i as zt,j as Lt,k as Bt,r as wt}from"./voxel-chunk-C2aVMRXz.js";function Nt(d){const{canvas:e,chunk:v,N:O,palette:B,camera:M,animSystem:I,animationTransforms:Ie,getMode:Q,setMode:q,getOption:V,setOption:pe,getHoverVoxel:Ee,setHoverVoxel:ke,getHoverFace:ye,setHoverFace:X,setNeedsPick:n,getDragging:be,setDragging:Ce,getLastX:F,setLastX:ie,getLastY:ae,setLastY:Re,getMouseX:Me,setMouseX:ee,getMouseY:ge,setMouseY:ue,getLastTime:_e,setLastTime:Pe,getRowHoverSurf:st,setRowHoverSurf:Ue,getRowHoverAdd:ct,setRowHoverAdd:lt,getPlaneHoverSurf:Ke,setPlaneHoverSurf:je,getPlaneHoverAdd:J,setPlaneHoverAdd:K,buildAllMeshes:_,updateChunkSizeUI:W,updateCameraTargetUI:fe,moveCameraTargetX:xe,moveCameraTargetY:Xe,moveCameraTargetZ:re,clearHistory:Se,undo:De,redo:Te,shiftVoxels:te,expandChunkX:Qe,expandChunkY:Ye,expandChunkZ:ze,shrinkChunkX:et,shrinkChunkY:Oe,shrinkChunkZ:se,exportToJSON:ce,importFromJSON:he,decodePickAt:j,getRowSurfaceVoxels:Le,getRowAddTargets:Be,getPlaneSurfaceVoxels:Ve,getPlaneAddTargets:tt,beginVoxelAction:H,recordVoxelChange:D,commitAction:$,getSelectedGroupName:dt,setSelectedGroupName:ne,getGroupOverlaysVisible:G,setGroupOverlaysVisible:mt,FACE_DIRS:nt}=d,He=document.getElementById("x"),Ge=document.getElementById("y"),Ze=document.getElementById("z"),ot=document.getElementById("btnUndo"),it=document.getElementById("btnRedo"),we=document.getElementById("fileInput"),ve=document.querySelector(".side-panel"),at=document.getElementById("btnToggleMenu"),We=document.getElementById("btnCloseMenu");at.addEventListener("click",()=>{ve.classList.toggle("open")}),We.addEventListener("click",()=>{ve.classList.remove("open")}),window.addEventListener("keydown",s=>{s.key==="Escape"&&(ve.classList.contains("open")&&ve.classList.remove("open"),animPanel.classList.contains("open")&&animPanel.classList.remove("open"))}),document.querySelectorAll('input[name="modeSelect"]').forEach(s=>{s.addEventListener("change",a=>{a.target.checked&&q(a.target.value)})}),document.querySelectorAll('input[name="optionSelect"]').forEach(s=>{s.addEventListener("change",a=>{a.target.checked&&pe(a.target.value)})}),document.getElementById("btnImport").addEventListener("click",()=>we.click()),document.getElementById("btnExport").addEventListener("click",()=>{const s=ce(),a=new Blob([JSON.stringify(s,null,2)],{type:"application/json"}),g=URL.createObjectURL(a),f=document.createElement("a");f.href=g,f.download="voxels.json",f.click(),URL.revokeObjectURL(g)}),we.addEventListener("change",s=>{const a=s.target.files[0];if(!a)return;const g=new FileReader;g.onload=()=>{try{const f=JSON.parse(g.result);he(f)}catch(f){alert("Invalid JSON: "+f.message)}finally{we.value=""}},g.readAsText(a)}),document.getElementById("resetSolid").addEventListener("click",()=>{v.resetSize(),v.seedMaterials("bands"),B.reset(),M.target=[8,8,8];const s=d.buildAxisGizmo;s&&s(),_(),W(),fe(),Se()}),document.getElementById("btnShiftXPos").addEventListener("click",()=>te(1,0,0)),document.getElementById("btnShiftXNeg").addEventListener("click",()=>te(-1,0,0)),document.getElementById("btnShiftYPos").addEventListener("click",()=>te(0,1,0)),document.getElementById("btnShiftYNeg").addEventListener("click",()=>te(0,-1,0)),document.getElementById("btnShiftZPos").addEventListener("click",()=>te(0,0,1)),document.getElementById("btnShiftZNeg").addEventListener("click",()=>te(0,0,-1)),document.getElementById("btnExpandX").addEventListener("click",Qe),document.getElementById("btnExpandY").addEventListener("click",Ye),document.getElementById("btnExpandZ").addEventListener("click",ze),document.getElementById("btnShrinkX").addEventListener("click",et),document.getElementById("btnShrinkY").addEventListener("click",Oe),document.getElementById("btnShrinkZ").addEventListener("click",se),document.getElementById("btnCameraXMinus").addEventListener("click",()=>xe(-1)),document.getElementById("btnCameraXPlus").addEventListener("click",()=>xe(1)),document.getElementById("btnCameraYMinus").addEventListener("click",()=>Xe(-1)),document.getElementById("btnCameraYPlus").addEventListener("click",()=>Xe(1)),document.getElementById("btnCameraZMinus").addEventListener("click",()=>re(-1)),document.getElementById("btnCameraZPlus").addEventListener("click",()=>re(1)),ot.addEventListener("click",De),it.addEventListener("click",Te);function $e(){const s=Ee(),a=ye();if(s<0||a<0){He.textContent="-",Ge.textContent="-",Ze.textContent="-";return}const[g,f,u]=v.coordsOf(s);He.textContent=g,Ge.textContent=f,Ze.textContent=u}d.updateHoverUI=$e,window.addEventListener("keydown",s=>{const a=s.key.toLowerCase();if(a==="q"){document.getElementById("modePaint").checked=!0,q("paint");return}if(a==="w"){document.getElementById("modeCarve").checked=!0,q("carve");return}if(a==="s"){document.getElementById("modeAdd").checked=!0,q("add");return}if(!s.ctrlKey&&a==="v"){document.getElementById("optionVoxel").checked=!0,pe("voxel");return}if(a==="r"){document.getElementById("optionRow").checked=!0,pe("row");return}if(a==="p"){document.getElementById("optionPlane").checked=!0,pe("plane");return}if((s.ctrlKey||s.metaKey)&&!s.shiftKey&&a==="z"){s.preventDefault(),De();return}if((s.ctrlKey||s.metaKey)&&(a==="y"||s.shiftKey&&a==="z")){s.preventDefault(),Te();return}/^[0-9]$/.test(a)?B.selectBrush(parseInt(a,10)):/^[a-f]$/i.test(a)&&B.selectBrush(10+parseInt(a,16)-10),n(!0)}),window.addEventListener("keyup",s=>{n(!0)}),e.addEventListener("contextmenu",s=>s.preventDefault()),e.addEventListener("mousedown",s=>{e.focus();const a=j(s.clientX,s.clientY),g=Q(),f=V();if(a.voxel<0||a.face<0){s.button===0&&(Ce(!0),ie(s.clientX),Re(s.clientY));return}if(s.button===0&&g==="paint"){if(f=="plane"){const u=Ve(a.voxel,a.face);if(u.length>0){const E=H("Paint plane");for(const h of u)D(E,h,!0,B.getBrush());$(E)}}else if(f=="row"){const u=Le(a.voxel,a.face);if(u.length>0){const E=H("Paint row");for(const h of u)D(E,h,!0,B.getBrush());$(E)}}else if(a.voxel>=0){const u=v.idx3(...v.coordsOf(a.voxel));if(v.isSolid(u)){const E=H("Paint voxel");D(E,a.voxel,!0,B.getBrush()),$(E)}}}else if(s.button===0&&g==="add"){if(f=="plane"){const u=tt(a.voxel,a.face);if(u.length>0){const E=H("Add plane");for(const h of u)D(E,h,!0,B.getBrush());$(E)}}else if(f=="row"){const u=Be(a.voxel,a.face);if(u.length>0){const E=H("Add row");for(const h of u)D(E,h,!0,B.getBrush());$(E)}}else if(a.voxel>=0&&a.face>=0){const[u,E,h]=v.coordsOf(a.voxel),A=nt[a.face],w=u+A[0],C=E+A[1],R=h+A[2];if(v.within(w,C,R)){const b=v.idx3(w,C,R);if(!v.isSolid(b)){const L=H("Add voxel");D(L,b,!0,B.getBrush()),$(L)}}}n(!0)}else if(s.button===0&&g==="carve"){if(f=="plane"){const u=Ve(a.voxel,a.face),E=H("Remove plane");for(const h of u)D(E,h,!1,v.material(h));$(E)}else if(f=="row"){const u=Le(a.voxel,a.face),E=H("Remove row");for(const h of u)D(E,h,!1,v.material(h));$(E)}else if(a.voxel>=0&&v.isSolid(a.voxel)){const u=H("Remove voxel");D(u,a.voxel,!1,v.material(a.voxel)),$(u)}n(!0)}}),window.addEventListener("mouseup",()=>{Ce(!1)}),window.addEventListener("mousemove",s=>{const a=be();if(a||(ee(s.clientX),ue(s.clientY),n(!0)),a){const g=F(),f=ae(),u=s.clientX-g,E=s.clientY-f;ie(s.clientX),Re(s.clientY);const h=.005;M.theta+=u*h,M.phi-=E*h,M.clamp()}},{passive:!0}),e.addEventListener("wheel",s=>{s.preventDefault();const a=Math.pow(1.1,s.deltaY*.01);M.radius*=a,M.clamp()},{passive:!1});function qe(){const s=document.getElementById("animationList");if(s){if(s.innerHTML="",d.animSystem.animations.size===0&&d.animSystem.emitters.size===0&&d.animSystem.sequences.size===0){s.innerHTML='<p style="color: #888; font-size: 12px; margin: 8px 0;">No animations, emitters, or sequences defined</p>';return}if(d.animSystem.animations.size>0){const a=document.createElement("h5");a.textContent="Animations",a.style.margin="8px 0 4px 0",s.appendChild(a)}for(const[a,g]of d.animSystem.animations.entries()){const f=document.createElement("div");f.className="animation-item";const u=document.createElement("div");u.className="animation-info";const E=document.createElement("span");E.className="animation-name",E.textContent=a;const h=document.createElement("span");if(h.className="animation-group",h.textContent=g.regionName||"no region",g.loop){const b=document.createElement("span");b.className="animation-badge",b.textContent="loop",u.appendChild(b)}u.appendChild(E),u.appendChild(h);const A=document.createElement("div");A.className="animation-controls-inline";const w=document.createElement("button");w.textContent="▶",w.title="Play",w.className="animation-btn",w.addEventListener("click",()=>{d.animSystem.playAnimation(a)});const C=document.createElement("button");C.textContent="⏹",C.title="Stop",C.className="animation-btn",C.addEventListener("click",()=>{d.animSystem.stopAnimation(a)});const R=document.createElement("button");R.textContent="↺",R.title="Reset",R.className="animation-btn",R.addEventListener("click",()=>{d.animSystem.resetAnimation(a)}),A.appendChild(w),A.appendChild(C),A.appendChild(R),f.appendChild(u),f.appendChild(A),s.appendChild(f)}if(d.animSystem.emitters.size>0){const a=document.createElement("h5");a.textContent="Emitters",a.style.margin="12px 0 4px 0",s.appendChild(a);for(const[g,f]of d.animSystem.emitters.entries()){const u=document.createElement("div");u.className="animation-item";const E=document.createElement("div");E.className="animation-info";const h=document.createElement("span");h.className="animation-name",h.textContent=g;const A=document.createElement("span");A.className="animation-region",A.textContent=f.enabled?"active":"stopped";const w=document.createElement("span");w.className="animation-badge",w.textContent=`${f.particles.length} particles`,E.appendChild(h),E.appendChild(w),E.appendChild(A);const C=document.createElement("div");C.className="animation-controls-inline";const R=document.createElement("button");R.textContent="▶",R.title="Start",R.className="animation-btn",R.addEventListener("click",()=>{d.animSystem.startEmitter(g)});const b=document.createElement("button");b.textContent="⏹",b.title="Stop",b.className="animation-btn",b.addEventListener("click",()=>{d.animSystem.stopEmitter(g)});const L=document.createElement("button");L.textContent="✕",L.title="Clear particles",L.className="animation-btn",L.addEventListener("click",()=>{d.animSystem.clearEmitter(g)}),C.appendChild(R),C.appendChild(b),C.appendChild(L),u.appendChild(E),u.appendChild(C),s.appendChild(u)}}if(d.animSystem.sequences.size>0){const a=document.createElement("h5");a.textContent="Sequences",a.style.margin="12px 0 4px 0",s.appendChild(a);for(const[g,f]of d.animSystem.sequences.entries()){const u=document.createElement("div");u.className="animation-item";const E=document.createElement("div");E.className="animation-info";const h=document.createElement("span");h.className="animation-name",h.textContent=g;const A=document.createElement("span");A.className="animation-badge";const w=f.animationNames.length+f.emitterNames.length;A.textContent=`${w} items`;const C=document.createElement("span");C.className="animation-group";const R=[];f.animationNames.length>0&&R.push(`${f.animationNames.length} anim${f.animationNames.length!==1?"s":""}`),f.emitterNames.length>0&&R.push(`${f.emitterNames.length} emitter${f.emitterNames.length!==1?"s":""}`),C.textContent=R.join(", "),E.appendChild(h),E.appendChild(A),E.appendChild(C);const b=document.createElement("div");b.className="animation-controls-inline";const L=document.createElement("button");L.textContent="▶",L.title="Play sequence",L.className="animation-btn",L.addEventListener("click",()=>{d.animSystem.playSequence(g)});const N=document.createElement("button");N.textContent="⏹",N.title="Stop sequence",N.className="animation-btn",N.addEventListener("click",()=>{d.animSystem.stopSequence(g)});const Z=document.createElement("button");Z.textContent="↺",Z.title="Reset sequence",Z.className="animation-btn",Z.addEventListener("click",()=>{d.animSystem.resetSequence(g)}),b.appendChild(L),b.appendChild(N),b.appendChild(Z),u.appendChild(E),u.appendChild(b),s.appendChild(u)}}}}function Ae(){const s=document.getElementById("regionList");if(!s)return;if(s.innerHTML="",d.animSystem.regions.size===0){s.innerHTML='<p style="color: #888; font-size: 12px; margin: 8px 0;">No regions defined</p>';return}const a=d.getGroupOverlaysVisible(),g=d.getSelectedGroupName();for(const[f,u]of d.animSystem.regions.entries()){const E=document.createElement("div");E.className="region-item",g===f&&E.classList.add("selected");const h=document.createElement("div");h.className="region-header";const A=document.createElement("span");A.className="region-name",A.textContent=f;const w=document.createElement("div");w.className="region-toggle";const C=document.createElement("input");C.type="checkbox",C.id=`region-vis-${f}`,C.checked=a.get(f)||!1,C.addEventListener("change",P=>{a.set(f,P.target.checked),P.target.checked&&(d.setSelectedGroupName(f),Ae())});const R=document.createElement("label");R.htmlFor=`region-vis-${f}`,R.textContent="Show",w.appendChild(C),w.appendChild(R),h.appendChild(A),h.appendChild(w);const b=document.createElement("div");b.className="region-bounds";const L=document.createElement("div");L.className="bounds-col";const N=document.createElement("div");N.className="bounds-label",N.textContent="Min",L.appendChild(N),["x","y","z"].forEach((P,oe)=>{const Y=document.createElement("div");Y.className="bounds-row";const le=document.createElement("label");le.textContent=P.toUpperCase();const U=document.createElement("input");U.type="number",U.min="0",U.max="15",U.value=u.min[oe],U.addEventListener("change",de=>{const me=Math.max(0,Math.min(15,parseInt(de.target.value)||0));u.min[oe]=me,de.target.value=me,d.chunk.clearGroups(),d.animSystem.regions.forEach((t,o)=>{d.chunk.addGroup(o,t.min,t.max)}),d.animSystem.assignVoxelsToGroups(d.chunk),d.buildAllMeshes()}),Y.appendChild(le),Y.appendChild(U),L.appendChild(Y)});const Z=document.createElement("div");Z.className="bounds-col";const Ne=document.createElement("div");Ne.className="bounds-label",Ne.textContent="Max",Z.appendChild(Ne),["x","y","z"].forEach((P,oe)=>{const Y=document.createElement("div");Y.className="bounds-row";const le=document.createElement("label");le.textContent=P.toUpperCase();const U=document.createElement("input");U.type="number",U.min="0",U.max="15",U.value=u.max[oe],U.addEventListener("change",de=>{const me=Math.max(0,Math.min(15,parseInt(de.target.value)||0));u.max[oe]=me,de.target.value=me,d.chunk.clearGroups(),d.animSystem.regions.forEach((t,o)=>{d.chunk.addGroup(o,t.min,t.max)}),d.animSystem.assignVoxelsToGroups(d.chunk),d.buildAllMeshes()}),Y.appendChild(le),Y.appendChild(U),Z.appendChild(Y)}),b.appendChild(L),b.appendChild(Z),E.appendChild(h),E.appendChild(b),s.appendChild(E)}}document.getElementById("btnCompile")?.addEventListener("click",()=>{const s=document.getElementById("animationDSL").value;try{d.animSystem.parse(s),d.animSystem.assignVoxelsToGroups(d.chunk),d.chunk.clearGroups(),d.animSystem.regions.forEach((a,g)=>{d.chunk.addGroup(g,a.min,a.max)}),d.buildAllMeshes(),qe(),Ae()}catch(a){console.error("Animation compile error:",a),alert("Animation compile error: "+a.message)}}),document.getElementById("btnPlay")?.addEventListener("click",()=>{for(const[s,a]of d.animSystem.animations.entries())a.loop&&d.animSystem.playAnimation(s);for(const[s,a]of d.animSystem.emitters.entries())d.animSystem.startEmitter(s)}),document.getElementById("btnPause")?.addEventListener("click",()=>{for(const s of d.animSystem.animations.values())s.stop();for(const s of d.animSystem.emitters.values())s.stop()}),document.getElementById("btnResetAll")?.addEventListener("click",()=>{d.animSystem.resetAll()})}function Ft(){const d=document.getElementById("gl"),e=d.getContext("webgl2",{antialias:!0,alpha:!1});if(!e){alert("WebGL2 not supported");return}e.enable(e.DEPTH_TEST),e.enable(e.CULL_FACE),e.cullFace(e.BACK);const v=Fe(e,Ct,bt);v.meta.visible=!0,v.meta.regions={};const O=Fe(e,St,Rt),B=Fe(e,zt,Tt),M=Fe(e,yt,At),I=Fe(e,Bt,Lt),Ie=ft();e.bindVertexArray(B.vao),e.bindBuffer(e.ARRAY_BUFFER,e.createBuffer()),e.bufferData(e.ARRAY_BUFFER,Ie.positions,e.STATIC_DRAW),e.enableVertexAttribArray(B.aPosition.location),e.vertexAttribPointer(B.aPosition.location,3,e.FLOAT,!1,0,0),e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,e.createBuffer()),e.bufferData(e.ELEMENT_ARRAY_BUFFER,Ie.indices,e.STATIC_DRAW),e.bindVertexArray(null);function Q(){const t=vt(n.sizeX,n.sizeZ);e.bindVertexArray(M.vao),e.bindBuffer(e.ARRAY_BUFFER,e.createBuffer()),e.bufferData(e.ARRAY_BUFFER,t.positions,e.STATIC_DRAW),e.enableVertexAttribArray(M.aPosition.location),e.vertexAttribPointer(M.aPosition.location,3,e.FLOAT,!1,0,0),e.bindBuffer(e.ARRAY_BUFFER,e.createBuffer()),e.bufferData(e.ARRAY_BUFFER,t.colors,e.STATIC_DRAW),e.enableVertexAttribArray(M.aColor.location),e.vertexAttribPointer(M.aColor.location,3,e.FLOAT,!1,0,0),e.bindVertexArray(null),M.meta.count=t.count}const q=pt();if(e.bindVertexArray(I.vao),I.aPosition&&(e.bindBuffer(e.ARRAY_BUFFER,e.createBuffer()),e.bufferData(e.ARRAY_BUFFER,q.positions,e.STATIC_DRAW),e.enableVertexAttribArray(I.aPosition.location),e.vertexAttribPointer(I.aPosition.location,3,e.FLOAT,!1,0,0)),I.aNormal&&(e.bindBuffer(e.ARRAY_BUFFER,e.createBuffer()),e.bufferData(e.ARRAY_BUFFER,q.normals,e.STATIC_DRAW),e.enableVertexAttribArray(I.aNormal.location),e.vertexAttribPointer(I.aNormal.location,3,e.FLOAT,!1,0,0)),I.aMatId){const t=new Uint8Array(q.positions.length/3);e.bindBuffer(e.ARRAY_BUFFER,e.createBuffer()),e.bufferData(e.ARRAY_BUFFER,t,e.STATIC_DRAW),e.enableVertexAttribArray(I.aMatId.location),e.vertexAttribIPointer(I.aMatId.location,1,e.UNSIGNED_BYTE,0,0)}e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,e.createBuffer()),e.bufferData(e.ELEMENT_ARRAY_BUFFER,q.indices,e.STATIC_DRAW),e.bindVertexArray(null);const V=new ht;let pe=new Map,Ee=0,ke=null,ye=new Map,X=16;const n=new Et(X),be=[[1,0,0],[-1,0,0],[0,1,0],[0,-1,0],[0,0,1],[0,0,-1],[0,0,0]],Ce=[{axis:0,u:2,v:1},{axis:0,u:2,v:1},{axis:1,u:0,v:2},{axis:1,u:0,v:2},{axis:2,u:0,v:1},{axis:2,u:0,v:1}];n.seedMaterials("bands"),Q();const F=new gt({target:[8,8,8],radius:40,theta:ut(215),phi:ut(60)}),ie=Je.identity();let ae=Je.perspective(60*Math.PI/180,1,.01,100);const Re=.22;let Me=1,ee=null,ge=null,ue=null,_e=0,Pe=0;function st(){const t=d.width,o=d.height;t===_e&&o===Pe&&ee||(ge&&e.deleteTexture(ge),ue&&e.deleteRenderbuffer(ue),ee&&e.deleteFramebuffer(ee),ge=e.createTexture(),e.bindTexture(e.TEXTURE_2D,ge),e.texImage2D(e.TEXTURE_2D,0,e.RGBA8,t,o,0,e.RGBA,e.UNSIGNED_BYTE,null),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),ue=e.createRenderbuffer(),e.bindRenderbuffer(e.RENDERBUFFER,ue),e.renderbufferStorage(e.RENDERBUFFER,e.DEPTH_COMPONENT16,t,o),ee=e.createFramebuffer(),e.bindFramebuffer(e.FRAMEBUFFER,ee),e.framebufferTexture2D(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.TEXTURE_2D,ge,0),e.framebufferRenderbuffer(e.FRAMEBUFFER,e.DEPTH_ATTACHMENT,e.RENDERBUFFER,ue),e.bindFramebuffer(e.FRAMEBUFFER,null),_e=t,Pe=o)}function Ue(){Me=Math.max(1,Math.min(2,window.devicePixelRatio||1));const t=d.clientWidth||d.parentElement.clientWidth,o=d.clientHeight||d.parentElement.clientHeight;d.width=Math.round(t*Me),d.height=Math.round(o*Me),e.viewport(0,0,d.width,d.height),ae=Je.perspective(60*Math.PI/180,d.width/d.height,.01,100),st()}window.addEventListener("resize",Ue,{passive:!0}),requestAnimationFrame(Ue);function ct(){e.bindFramebuffer(e.FRAMEBUFFER,ee),e.viewport(0,0,_e,Pe),e.clearColor(0,0,0,1),e.clear(e.COLOR_BUFFER_BIT|e.DEPTH_BUFFER_BIT);const t=e.isEnabled(e.CULL_FACE);t&&e.disable(e.CULL_FACE),e.useProgram(O.program),O.uModel.set(ie),O.uView.set(F.view()),O.uProj.set(ae),e.bindVertexArray(O.vao),e.drawElements(e.TRIANGLES,O.meta.pickVoxelCount,e.UNSIGNED_INT,0),_==="add"&&(e.bindVertexArray(O.vaoGround),e.drawElements(e.TRIANGLES,O.meta.pickGroundCount,e.UNSIGNED_INT,0)),e.bindVertexArray(null),t&&e.enable(e.CULL_FACE),e.bindFramebuffer(e.FRAMEBUFFER,null)}function lt(t,o){const l=d.getBoundingClientRect(),i=Math.floor((t-l.left)*(d.width/l.width)),r=Math.floor((l.height-(o-l.top))*(d.height/l.height));return{x:i,y:r}}function Ke(t,o){if(O.meta.pickVoxelCount===0&&O.meta.pickGroundCount===0)return{voxel:-1,face:-1};ct();const{x:l,y:i}=lt(t,o),r=new Uint8Array(4);e.bindFramebuffer(e.FRAMEBUFFER,ee),e.readPixels(l,i,1,1,e.RGBA,e.UNSIGNED_BYTE,r),e.bindFramebuffer(e.FRAMEBUFFER,null);const m=r[0]|r[1]<<8|r[2]<<16;if(m===0)return{voxel:-1,face:-1};const c=m&7,x=(m>>4)-1;return x<0||x>=n.length?{voxel:-1,face:-1}:{voxel:x,face:c}}function je(t,o,l,i,r,m,c,x=1.006){const y=i-t+1,S=r-o+1,T=m-l+1,z=t+y*.5,k=o+S*.5,p=l+T*.5;e.useProgram(B.program),B.uModel.set(ie),B.uView.set(F.view()),B.uProj.set(ae),B.uOffset.set(new Float32Array([z,k,p])),B.uScaleVec.set(new Float32Array([y,S,T])),B.uInflate.set(x),B.uColor.set(new Float32Array(c)),e.bindVertexArray(B.vao),e.drawElements(e.LINES,Ie.count,e.UNSIGNED_SHORT,0),e.bindVertexArray(null)}function J(t,o,l=1.006){const[i,r,m]=n.coordsOf(t);je(i,r,m,i,r,m,o,l)}const K=new xt(document.getElementById("palette"),t=>{},(t,o,l)=>{const i=Ve(`Palette ${t}`);tt(i,t,o,l),D(i,!1)});let _=document.querySelector('input[name="modeSelect"]:checked').value,W=document.querySelector('input[name="optionSelect"]:checked').value;function fe(t){return t>=0&&t<=9?String.fromCharCode(48+t):t>=10&&t<=15?String.fromCharCode(97+(t-10)):"0"}function xe(t){return Math.max(0,Math.min(255,t)).toString(16).padStart(2,"0")}function Xe(){const t=[];for(let r=0;r<16;r++)t.push(wt(K.colors[r*3+0],K.colors[r*3+1],K.colors[r*3+2]));const o=[],i=Math.max(n.sizeX,n.sizeY,n.sizeZ)<=16;for(let r=0;r<n.sizeZ;r++)for(let m=0;m<n.sizeY;m++)for(let c=0;c<n.sizeX;c++){const x=n.idx3(c,m,r);n.isSolid(x)&&(i?o.push(`${fe(c)}${fe(m)}${fe(r)}${fe(n.material(x))}`):o.push(`${xe(c)}${xe(m)}${xe(r)}${fe(n.material(x))}`))}return Object.assign({version:1,size:[n.sizeX,n.sizeY,n.sizeZ],palette:t,voxels:o},V.toJSON())}function re(t){const o=t.toLowerCase();return o>="0"&&o<="9"?o.charCodeAt(0)-48:o>="a"&&o<="f"?10+(o.charCodeAt(0)-97):0}function Se(t){return parseInt(t,16)||0}function De(t){if(!t||typeof t!="object")throw new Error("Root must be object");if(!Array.isArray(t.voxels))throw new Error('Missing "voxels"');let o,l,i;if(Array.isArray(t.size)){if(t.size.length!==3)throw new Error("Size array must have 3 elements [x, y, z]");[o,l,i]=t.size}else if(typeof t.size=="number")o=l=i=t.size;else throw new Error('Invalid "size" field');if(o===16&&l===16&&i===16?n.resetSize():(n.resetSize(),n.expandSize(o,l,i)),X=Math.max(o,l,i),F.target=[o/2,l/2,i/2],Q(),Array.isArray(t.palette))for(let r=0;r<Math.min(16,t.palette.length);r++){const m=t.palette[r];let c;typeof m=="string"?c=rt(m):Array.isArray(m)&&m.length>=3&&(c=[+m[0],+m[1],+m[2]]),c&&K.setPaletteColor(r,[Math.max(0,Math.min(1,c[0])),Math.max(0,Math.min(1,c[1])),Math.max(0,Math.min(1,c[2]))])}n.fill(!1),n.setMaterialAll(0);for(const r of t.voxels){if(!r)continue;let m,c,x,y;if(typeof r=="string")if(r.length===4)m=re(r[0]),c=re(r[1]),x=re(r[2]),y=(re(r[3])|0)&15;else if(r.length===7)m=Se(r.substring(0,2)),c=Se(r.substring(2,4)),x=Se(r.substring(4,6)),y=(re(r[6])|0)&15;else continue;else if(Array.isArray(r)&&r.length>=4)[m,c,x,y]=r;else continue;if(n.within(m,c,x)){const S=n.idx3(m,c,x);n.setSolid(S,!0),n.setMaterial(S,y)}}N(),ne(),G(),t.regions&&V.fromJSON(t),j()}const Te=[{axis:0,u:2,v:1},{axis:0,u:2,v:1},{axis:1,u:0,v:2},{axis:1,u:0,v:2},{axis:2,u:0,v:1},{axis:2,u:0,v:1},{axis:1,u:0,v:2}];function te(t,o){if(t<0||o<0||o>Te.length)return[];const l=Te[o],[i,r,m]=n.coordsOf(t),c=l.u,x=l.v,y=l.axis,S=[i,r,m][c],T=[i,r,m][x],z=[];for(let k=0;k<X;k++){const p=[0,0,0];p[c]=S,p[x]=T,p[y]=k,n.within(p[0],p[1],p[2])&&n.isSolid(n.idx3(p[0],p[1],p[2]))&&z.push(n.idx3(p[0],p[1],p[2]))}return z}const Qe=[{axis:0,u:2,v:1},{axis:0,u:2,v:1},{axis:1,u:0,v:2},{axis:1,u:0,v:2},{axis:2,u:0,v:1},{axis:2,u:0,v:1},{axis:1,u:0,v:2}];function Ye(t,o){if(t<0||o<0)return[];const l=Qe[o],[i,r,m]=n.coordsOf(t),c=l.u,x=l.v,y=l.axis,S=[i,r,m][c],T=[i,r,m][x],z=[];for(let k=0;k<X;k++){const p=[0,0,0];p[c]=S,p[x]=T,p[y]=k,n.within(p[0],p[1],p[2])&&(n.isSolid(n.idx3(p[0],p[1],p[2]))||z.push(n.idx3(p[0],p[1],p[2])))}return z}function ze(t,o){if(t<0||o<0||o>=Ce.length)return[];const l=Ce[o],[i,r,m]=n.coordsOf(t),c=l.axis,x=l.u,y=l.v,S=[i,r,m][c],T=[];for(let z=0;z<X;z++)for(let k=0;k<X;k++){const p=[0,0,0];if(p[c]=S,p[x]=z,p[y]=k,o==6){if(!n.within(p[0],p[1],p[2])||!n.isSolid(n.idx3(p[0],p[1],p[2])))continue;T.push(n.idx3(p[0],p[1],p[2]));continue}n.within(p[0],p[1],p[2])&&n.isSolid(n.idx3(p[0],p[1],p[2]))&&n.faceExposed(p[0],p[1],p[2],o)&&T.push(n.idx3(p[0],p[1],p[2]))}return T}function et(){const t=[];for(let o=0;o<n.sizeX;o++)for(let l=0;l<n.sizeZ;l++)t.push(n.idx3(o,0,l));return t}function Oe(t,o){const l=be[o],i=o===6?et():ze(t,o),r=new Set;for(const c of i){const[x,y,S]=n.coordsOf(c),T=x+l[0],z=y+l[1],k=S+l[2];n.within(T,z,k)&&!n.isSolid(n.idx3(T,z,k))&&r.add(n.idx3(T,z,k))}return[...r]}const se=[],ce=[];function he(){const t=document.getElementById("btnUndo"),o=document.getElementById("btnRedo");t.disabled=se.length===0,o.disabled=ce.length===0}function j(){se.length=0,ce.length=0,he()}function Le(t){return{type:"voxels",label:t,vox:[]}}function Be(t,o,l,i=n.material(o)){const r=n.isSolid(o),m=n.material(o);r===l&&m===i||(t.vox.push({idx:o,fromS:r,fromM:m,toS:l,toM:i}),n.setSolid(o,l),n.setMaterial(o,i))}function Ve(t){return{type:"palette",label:t,pal:[]}}function tt(t,o,l,i){const r=rt(l),m=rt(i);l!==i&&t.pal.push({i:o,from:r,to:m})}function H(t,o){if(t.type==="voxels"){const l=t.vox;if(o==="undo")for(const i of l)n.setSolid(i.idx,i.fromS),n.setMaterial(i.idx,i.fromM);else for(const i of l)n.setSolid(i.idx,i.toS),n.setMaterial(i.idx,i.toM)}else if(t.type==="palette"){const l=t.pal;if(o==="undo")for(const i of l)K.setPaletteColor(i.i,i.from);else for(const i of l)K.setPaletteColor(i.i,i.to)}}function D(t,o=!0){t.type==="voxels"&&t.vox.length===0||t.type==="palette"&&(!t.pal||t.pal.length===0)||(se.push(t),ce.length=0,he(),t.type==="voxels"&&o&&N())}function $(){if(se.length===0)return;const t=se.pop();H(t,"undo"),ce.push(t),he(),t.type==="voxels"&&N()}function dt(){if(ce.length===0)return;const t=ce.pop();H(t,"do"),se.push(t),he(),t.type==="voxels"&&N()}function ne(){document.getElementById("sizeX").textContent=n.sizeX,document.getElementById("sizeY").textContent=n.sizeY,document.getElementById("sizeZ").textContent=n.sizeZ}function G(){document.getElementById("cameraX").textContent=Math.round(F.target[0]),document.getElementById("cameraY").textContent=Math.round(F.target[1]),document.getElementById("cameraZ").textContent=Math.round(F.target[2])}function mt(t){F.target[0]+=t,G()}function nt(t){F.target[1]+=t,G()}function He(t){F.target[2]+=t,G()}function Ge(){const t=n.sizeX+1;n.expandSize(t,n.sizeY,n.sizeZ),X=Math.max(n.sizeX,n.sizeY,n.sizeZ),F.target=[n.sizeX/2,n.sizeY/2,n.sizeZ/2],Q(),N(),ne(),G(),j()}function Ze(){const t=n.sizeY+1;n.expandSize(n.sizeX,t,n.sizeZ),X=Math.max(n.sizeX,n.sizeY,n.sizeZ),F.target=[n.sizeX/2,n.sizeY/2,n.sizeZ/2],N(),ne(),G(),j()}function ot(){const t=n.sizeZ+1;n.expandSize(n.sizeX,n.sizeY,t),X=Math.max(n.sizeX,n.sizeY,n.sizeZ),F.target=[n.sizeX/2,n.sizeY/2,n.sizeZ/2],Q(),N(),ne(),G(),j()}function it(){if(n.sizeX<=1)return;const t=n.sizeX-1;n.expandSize(t,n.sizeY,n.sizeZ),X=Math.max(n.sizeX,n.sizeY,n.sizeZ),F.target=[n.sizeX/2,n.sizeY/2,n.sizeZ/2],Q(),N(),ne(),G(),j()}function we(){if(n.sizeY<=1)return;const t=n.sizeY-1;n.expandSize(n.sizeX,t,n.sizeZ),X=Math.max(n.sizeX,n.sizeY,n.sizeZ),F.target=[n.sizeX/2,n.sizeY/2,n.sizeZ/2],N(),ne(),G(),j()}function ve(){if(n.sizeZ<=1)return;const t=n.sizeZ-1;n.expandSize(n.sizeX,n.sizeY,t),X=Math.max(n.sizeX,n.sizeY,n.sizeZ),F.target=[n.sizeX/2,n.sizeY/2,n.sizeZ/2],Q(),N(),ne(),G(),j()}function at(t,o,l){const i=Le(`Shift ${t!==0?t>0?"+X":"-X":o!==0?o>0?"+Y":"-Y":l>0?"+Z":"-Z"}`),r=new Array(n.length),m=new Uint8Array(n.length);for(let c=0;c<n.length;c++)r[c]=n.isSolid(c),m[c]=n.material(c);for(let c=0;c<n.length;c++)n.setSolid(c,!1),n.setMaterial(c,0);for(let c=0;c<n.sizeZ;c++)for(let x=0;x<n.sizeY;x++)for(let y=0;y<n.sizeX;y++){const S=n.idx3(y,x,c);if(!r[S])continue;const T=y+t,z=x+o,k=c+l;if(n.within(T,z,k)){const p=n.idx3(T,z,k);Be(i,p,!0,m[S])}else Be(i,S,!1,m[S])}for(const c of V.regions.values())c.min[0]+=t,c.min[1]+=o,c.min[2]+=l,c.max[0]+=t,c.max[1]+=o,c.max[2]+=l;for(const c of V.animations.values())for(const x of c.keyframes)x.type==="rotate"&&x.pivot&&(x.pivot[0]+=t,x.pivot[1]+=o,x.pivot[2]+=l);D(i,!0)}let We=!1,$e=0,qe=0,Ae=0,s=0,a=!0,g=-1,f=-1,u=[],E=[],h=[],A=[],w=()=>{};function C(){if(!a)return;a=!1;const t=Ke(Ae,s);g=t.voxel,f=t.face,w(),g>=0&&f>=0?(_==="add"&&W==="row"?E=Ye(g,f):E=[],_!=="add"&&W==="row"?u=te(g,f):u=[],_==="add"&&W==="plane"?A=Oe(g,f):A=[],_!=="add"&&W==="plane"?h=ze(g,f):h=[]):(u=[],E=[],h=[],A=[])}const R=[1,.6,.2],b=[1,.32,.32],L=[.27,.95,.42];function N(){v.meta.renderIndexCount=n.buildGreedyRenderMeshMain(e,v,v.vao),n.buildPickFaces(e,O),v.meta.regions={};for(const[t,o]of V.regions.entries())v.meta.regions[t]={},v.meta.regions[t].vao=e.createVertexArray(),v.meta.regions[t].visible=!0,v.meta.regions[t].indexCount=n.buildGreedyRenderMeshRegion(e,v,v.meta.regions[t].vao,t)}N();const Z=1e3,Ne=2,P=64,oe=Math.ceil(Z*Ne/P),Y=e.createTexture();e.bindTexture(e.TEXTURE_2D,Y),e.texImage2D(e.TEXTURE_2D,0,e.RGBA32F,P,oe,0,e.RGBA,e.FLOAT,null),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE);const le=e.getError();le!==e.NO_ERROR&&console.error("Texture creation error:",le);function U(t){const o=new Float32Array(P*oe*4);for(let l=0;l<t.length;l++){const i=t[l],r=l*2,m=l*2+1,c=r%P,x=Math.floor(r/P),y=m%P,S=Math.floor(m/P),T=(x*P+c)*4,z=(S*P+y)*4;o[T+0]=i.position[0],o[T+1]=i.position[1],o[T+2]=i.position[2],o[T+3]=i.size,o[z+0]=i.color/255,o[z+1]=i.getAlpha(),o[z+2]=0,o[z+3]=0}e.bindTexture(e.TEXTURE_2D,Y),e.texSubImage2D(e.TEXTURE_2D,0,0,0,P,oe,e.RGBA,e.FLOAT,o)}function de(){const t=performance.now(),o=(t-Ee)/1e3;Ee=t,V.update(o),e.clearColor(.07,.08,.1,1),e.clear(e.COLOR_BUFFER_BIT|e.DEPTH_BUFFER_BIT),e.useProgram(v.program),v.uPalette.set(K.colors),v.uView.set(F.view()),v.uProj.set(ae),v.uNormalMat.set(new Float32Array([1,0,0,0,1,0,0,0,1])),v.uLightDirWS.set(new Float32Array([.7/1.7,-1.2/1.7,.9/1.7])),v.uAmbient.set(Re),v.meta.visible&&(v.uModel.set(ie),e.bindVertexArray(v.vao),e.drawElements(e.TRIANGLES,v.meta.renderIndexCount,e.UNSIGNED_INT,0),e.bindVertexArray(null)),Object.keys(v.meta.regions).forEach(i=>{const r=v.meta.regions[i];if(!r.visible)return;const m=V.getRegionTransform(i),c=Je.multiply(ie,m);v.uModel.set(c),e.bindVertexArray(r.vao),e.drawElements(e.TRIANGLES,r.indexCount,e.UNSIGNED_INT,0),e.bindVertexArray(null)}),e.useProgram(M.program),M.uModel.set(ie),M.uView.set(F.view()),M.uProj.set(ae),e.bindVertexArray(M.vao),e.drawArrays(e.LINES,0,M.meta.count),e.bindVertexArray(null);const l=V.getAllParticles();if(l.length>0){e.enable(e.BLEND),e.blendFunc(e.SRC_ALPHA,e.ONE_MINUS_SRC_ALPHA),e.useProgram(I.program),I.uPalette.set(K.colors),I.uView.set(F.view()),I.uProj.set(ae),I.uLightDirWS.set(new Float32Array([.7/1.7,-1.2/1.7,.9/1.7])),I.uAmbient.set(Re),U(l),e.activeTexture(e.TEXTURE0),e.bindTexture(e.TEXTURE_2D,Y),I.uParticleData.set(0),I.uTextureWidth.set(P),e.bindVertexArray(I.vao),e.drawElementsInstanced(e.TRIANGLES,q.count,e.UNSIGNED_SHORT,0,l.length);const i=e.getError();i!==e.NO_ERROR&&console.error("Draw error:",i,"hex:",i.toString(16)),e.bindVertexArray(null),e.disable(e.BLEND)}if(C(),_!=="move"&&g>=0&&f>=0){if(W==="plane"){if(_==="add")for(const i of A)J(i,L,1.006);else if(_==="carve")for(const i of h)J(i,b,1.006);else if(_==="paint")for(const i of h)J(i,R,1.006)}else if(W==="row"){if(_==="add")for(const i of E)J(i,L,1.006);else if(_==="carve")for(const i of u)J(i,b,1.006);else if(_==="paint")for(const i of u)J(i,R,1.006)}else if(W==="voxel"){if(_==="add"){const[i,r,m]=n.coordsOf(g),c=be[f],x=i+c[0],y=r+c[1],S=m+c[2];n.within(x,y,S)&&!n.isSolid(n.idx3(x,y,S))&&J(n.idx3(x,y,S),L,1.006)}else if(_==="carve"){const[i,r,m]=n.coordsOf(g),c=n.idx3(i,r,m);n.isSolid(c)&&J(g,b,1.006)}else if(_==="paint"){const[i,r,m]=n.coordsOf(g),c=n.idx3(i,r,m);n.isSolid(c)&&J(g,R,1.006)}}}for(const[i,r]of V.regions.entries())if(ye.get(i)){const[m,c,x]=r.min,[y,S,T]=r.max;je(m,c,x,y,S,T,ke===i?[.2,.6,1]:[.6,.8,.3],1.01)}requestAnimationFrame(de)}requestAnimationFrame(de),setTimeout(Ue,0);const me={canvas:d,chunk:n,N:X,palette:K,camera:F,animSystem:V,animationTransforms:pe,getMode:()=>_,setMode:t=>{_=t},getOption:()=>W,setOption:t=>{W=t},getHoverVoxel:()=>g,setHoverVoxel:t=>{g=t},getHoverFace:()=>f,setHoverFace:t=>{f=t},setNeedsPick:t=>{a=t},getDragging:()=>We,setDragging:t=>{We=t},getLastX:()=>$e,setLastX:t=>{$e=t},getLastY:()=>qe,setLastY:t=>{qe=t},getMouseX:()=>Ae,setMouseX:t=>{Ae=t},getMouseY:()=>s,setMouseY:t=>{s=t},getLastTime:()=>Ee,setLastTime:t=>{Ee=t},getRowHoverSurf:()=>u,setRowHoverSurf:t=>{u=t},getRowHoverAdd:()=>E,setRowHoverAdd:t=>{E=t},getPlaneHoverSurf:()=>h,setPlaneHoverSurf:t=>{h=t},getPlaneHoverAdd:()=>A,setPlaneHoverAdd:t=>{A=t},getSelectedRegionName:()=>ke,setSelectedRegionName:t=>{ke=t},getRegionOverlaysVisible:()=>ye,setRegionOverlaysVisible:t=>{ye=t},buildAllMeshes:N,buildAxisGizmo:Q,updateChunkSizeUI:ne,updateCameraTargetUI:G,moveCameraTargetX:mt,moveCameraTargetY:nt,moveCameraTargetZ:He,clearHistory:j,undo:$,redo:dt,shiftVoxels:at,expandChunkX:Ge,expandChunkY:Ze,expandChunkZ:ot,shrinkChunkX:it,shrinkChunkY:we,shrinkChunkZ:ve,exportToJSON:Xe,importFromJSON:De,decodePickAt:Ke,getRowSurfaceVoxels:te,getRowAddTargets:Ye,getPlaneSurfaceVoxels:ze,getPlaneAddTargets:Oe,beginVoxelAction:Le,recordVoxelChange:Be,commitAction:D,FACE_DIRS:be};Nt(me),w=me.updateHoverUI}document.addEventListener("DOMContentLoaded",Ft);
